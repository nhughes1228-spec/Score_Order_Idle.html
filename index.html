<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Score Order Idle</title>
  <style>
    :root{
      --ink:#1e1a16;
      --ink2:#2b241e;
      --muted:#5a4f45;
      --paper:#f3e7cf;
      --paper2:#eadbbd;
      --line:rgba(35,29,24,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.22);
      --radius:16px;
      --accent:#2c6e7a;
      --accent2:#6b3c2a;
      --good:#1d7a41;
      --warn:#8a5a00;
      --bad:#a03c3c;

      /* Transparent PNG baton cursor from your repo */
      --baton-cursor: url("assets/cursor-baton.png");
    }
    *{box-sizing:border-box}

    /* ---- FORCE BATON CURSOR EVERYWHERE (including clickable elements) ---- */
    html, body, body *{
      cursor: var(--baton-cursor) 0 0, auto !important;
    }
    button, a, summary, details, input, label, select, textarea{
      cursor: var(--baton-cursor) 0 0, auto !important;
    }

    body{
      margin:0;
      color:var(--ink);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;

      background:
        radial-gradient(1100px 800px at 18% 12%, rgba(44,110,122,.10), transparent 60%),
        radial-gradient(900px 700px at 82% 18%, rgba(107,60,42,.10), transparent 62%),
        radial-gradient(700px 500px at 40% 78%, rgba(0,0,0,.07), transparent 55%),
        url("assets/parchment.png") center/cover scroll,
        linear-gradient(180deg, var(--paper), var(--paper2));
      background-blend-mode: multiply, multiply, multiply, normal, normal;
    }

    html, body {
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
    }
    #noteBtn, .noteBtn, header, button, summary, details {
      touch-action: manipulation;
    }
    .noteBtn {
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.18;
      background:
        radial-gradient(220px 180px at 12% 22%, rgba(0,0,0,.18), transparent 70%),
        radial-gradient(260px 210px at 76% 18%, rgba(0,0,0,.13), transparent 72%),
        radial-gradient(300px 240px at 70% 74%, rgba(0,0,0,.10), transparent 75%),
        radial-gradient(280px 220px at 28% 78%, rgba(0,0,0,.10), transparent 75%);
      mix-blend-mode:multiply;
      filter: blur(0.3px);
    }

    header{
      padding:16px 16px 12px;
      position:sticky; top:0; z-index:5;
      background: linear-gradient(to bottom, rgba(243,231,207,.90), rgba(243,231,207,.72));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      transform: translateZ(0);
      will-change: transform;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .hud{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .pill{
      background: rgba(255,255,255,.70);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      box-shadow: 0 8px 22px rgba(0,0,0,.10);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .pill b{font-size:13px}
    main{padding:16px; max-width:1200px; margin:0 auto}
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(255,255,255,.75);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateZ(0);
      will-change: transform;
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:14px; letter-spacing:.3px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.55);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      flex-wrap:wrap;
    }
    .content{padding:12px 14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(35,29,24,.18)}
    .row:last-child{border-bottom:none}
    .muted{color:var(--muted)}

    button{
      background: rgba(255,255,255,.80);
      color:var(--ink2);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius: 12px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:800;
      letter-spacing:.2px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.90); border-color: rgba(44,110,122,.35)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.45}
    .primary{
      background: linear-gradient(135deg, rgba(44,110,122,.45), rgba(255,255,255,.80));
      border-color: rgba(44,110,122,.55);
    }
    .danger{border-color: rgba(160,60,60,.60)}
    .table{display:flex; flex-direction:column; gap:8px}
    .mini{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 10px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(35,29,24,.35);
      border-radius: 14px;
    }
    .mini .name{display:flex; flex-direction:column; gap:2px}
    .top{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(35,29,24,.30);
      color:var(--muted);
      background: rgba(255,255,255,.70);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      white-space: nowrap;
    }
    .tag.good{color:var(--good); border-color: rgba(29,122,65,.22); background: rgba(29,122,65,.06)}
    .tag.warn{color:var(--warn); border-color: rgba(138,90,0,.22); background: rgba(138,90,0,.06)}
    .tag.bad{color:var(--bad); border-color: rgba(160,60,60,.22); background: rgba(160,60,60,.06)}
    .right{display:flex; flex-direction:column; gap:6px; align-items:flex-end; justify-content:center}
    .cost{font-size:12px; color:var(--muted); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .clickZone{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; padding:16px 0 6px;
    }
    .noteBtn{
      width:220px; height:220px;
      border-radius: 999px;
      display:grid; place-items:center;
      user-select:none;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.88), rgba(255,255,255,.40));
      border:1px solid rgba(44,110,122,.26);
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
      color: var(--ink2);
      padding:0;
    }
    .noteBtn:hover{border-color: rgba(44,110,122,.55)}
    .noteBtn:active{transform: translateY(2px)}
    .noteBtn{
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .noteImg{
      width:160px; height:160px;
      object-fit: contain;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.40));
      image-rendering: auto;
      user-select:none;
      pointer-events:none;
    }

    .bigNotes{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 34px;
      color: rgba(43,36,30,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.55);
    }
    .miniHud{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .toast{
      position:fixed; right:14px; bottom:14px;
      display:flex; flex-direction:column; gap:8px;
      max-width: 420px;
      z-index:10;
    }
    .toast .t{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(35,29,24,.20);
      border-left: 4px solid rgba(44,110,122,.75);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      font-size: 12px;
      color: var(--ink2);
      backdrop-filter: blur(6px);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .footer{
      margin-top:10px; padding:10px 14px;
      color: var(--muted); font-size:12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.32);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .inkSig{
      font-family: "Brush Script MT", "Snell Roundhand", "Apple Chancery", cursive;
      font-size: 18px;
      color: rgba(43,36,30,.85);
    }
    .smallSans{font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .seg{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .seg button{
      padding:7px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }
    .seg button.active{
      background: rgba(44,110,122,.18);
      border-color: rgba(44,110,122,.35);
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .tabs button{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }
    .tabs button.active{
      background: rgba(44,110,122,.18);
      border-color: rgba(44,110,122,.35);
    }
    .tab[hidden]{display:none !important}

    details{
      border:1px solid rgba(35,29,24,.16);
      border-radius: 14px;
      background: rgba(255,255,255,.40);
      overflow:hidden;
    }
    details > summary{
      list-style:none;
      padding:10px 10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }
    details > summary::-webkit-details-marker{display:none}
    .detailsBody{padding:10px 10px; border-top:1px dashed rgba(35,29,24,.18)}
    .familyStack{display:flex; flex-direction:column; gap:10px}
    .dropdown{margin-top:10px}
    .settingRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px;
      border:1px solid rgba(35,29,24,.16);
      border-radius: 14px;
      background: rgba(255,255,255,.40);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight:800;
    }
    input[type="checkbox"]{transform: scale(1.15)}

    .repaint-kick *{
      transform: translateZ(0);
    }

    /* ---- Purchased / disabled look for one-time upgrades ---- */
    .mini.purchased{
      opacity:.78;
      filter: saturate(.88);
      background: rgba(255,255,255,.50);
      border-color: rgba(35,29,24,.28);
      box-shadow: inset 0 2px 10px rgba(0,0,0,.18);
    }
    .mini.purchased .right button{ display:none; }
    .mini.purchased .cost{ display:none; }
    .mini.purchased .afterPurchase{ display:none; }

    /* ---- Tutorial overlays ---- */
    .overlay{
      position:fixed; inset:0;
      z-index:1000;
      display:none;
    }
    .overlay.show{display:block}
    .overlay .veil{
      position:absolute; inset:0;
      background: rgba(20,16,12,.62);
      backdrop-filter: blur(2px);
    }
    .overlay .panel{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom:18px;
      width:min(720px, calc(100% - 24px));
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(35,29,24,.25);
      border-radius: 18px;
      box-shadow: 0 22px 60px rgba(0,0,0,.30);
      padding:14px 14px 12px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ink2);
    }
    .overlay .panel h3{
      margin:0 0 6px 0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .overlay .panel .msg{
      font-size:13px;
      color: rgba(43,36,30,.90);
      line-height:1.35;
    }
    .overlay .panel .actions{
      margin-top:10px;
      display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;
    }
    .overlay .panel .actions button{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }

    .tutorial-highlight{
      position:relative;
      z-index:1002 !important;
      outline: 3px solid rgba(44,110,122,.70);
      box-shadow: 0 0 0 7px rgba(44,110,122,.22), 0 18px 60px rgba(0,0,0,.35);
      border-radius: 18px;
    }
    /* noteBtn is round; keep it round when highlighted */
    .tutorial-highlight.noteBtn{
      border-radius:999px;
    }

    /* Start screen panel in center */
    .startPanel{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1001;
    }
    .startCard{
      width:min(720px, calc(100% - 24px));
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(35,29,24,.25);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.35);
      padding:18px 18px 16px;
      text-align:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .startTitle{
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      font-size:26px;
      letter-spacing:.4px;
      margin:0 0 6px 0;
      color: rgba(43,36,30,.95);
    }
    .startSub{
      margin:0 0 14px 0;
      color: rgba(90,79,69,.95);
      font-size:13px;
      line-height:1.35;
    }
    .startBtn{
      font-size:14px !important;
      padding:12px 16px !important;
      border-radius: 999px !important;
    }
    .centerButtons{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Score Order Idle</h1>
    <div class="sub">Conduct with a baton, hire instruments, Ink is meta, ‚ÄúTake a bow‚Äù for Patrons.</div>
  </div>

  <div class="hud">
    <div class="tabs" aria-label="Pages">
      <button class="active" data-tab="main">Main</button>
      <button data-tab="stats">Stats</button>
      <button data-tab="prestige" id="prestigeTabBtn" hidden>Prestige</button>
      <button data-tab="settings">Settings</button>
    </div>

    <div class="pill"><span class="muted">Notes</span> <b class="mono" id="notesHud">0</b></div>
    <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="npsHud">0</b></div>
    <div class="pill"><span class="muted">Click</span> <b class="mono" id="npcHud">1</b><span class="muted">/click</span></div>
    <div class="pill"><span class="muted">Ink</span> <b class="mono" id="inkHud">0</b></div>
    <div class="pill"><span class="muted">Patrons</span> <b class="mono" id="patronsHud">0</b></div>
  </div>
</header>

<main>
  <div class="tab" id="tab-main">
    <div class="grid">

      <section class="card">
        <h2>
          <span>üéº The Score</span>
          <span class="tag good">Autosave: ON</span>
        </h2>
        <div class="content">
          <div class="clickZone">
            <button class="noteBtn" id="noteBtn" aria-label="Click the note"></button>

            <div class="bigNotes mono" id="bigNotes">0 Notes</div>

            <div class="miniHud">
              <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="npsMini">0</b></div>
              <div class="pill"><span class="muted">Ink bonus</span> <b class="mono" id="inkBonusMini">x1.000</b></div>
              <div class="pill"><span class="muted">Patron bonus</span> <b class="mono" id="patronBonusMini">x1.00</b></div>
            </div>

            <div class="muted" style="text-align:center; max-width:560px;">
              <span class="inkSig">In ink, we trust.</span>
              <!-- instruction line removed; tutorial handles onboarding -->
            </div>
          </div>

          <details class="dropdown" id="batonDropdown">
            <summary>
              <span>Baton Techniques (Notes)</span>
              <span class="tag" id="batonTag">Whole Note</span>
            </summary>
            <div class="detailsBody">
              <div class="muted smallSans" style="margin-bottom:8px;">
                These upgrades change your note symbol and increase base click value.
                (They reset when you ‚ÄúTake a bow.‚Äù)
              </div>
              <div class="table" id="batonUpgradeList"></div>
            </div>
          </details>

          <div class="row">
            <div>
              <b>Take a bow: Court Patrons</b>
              <div class="muted smallSans">Patron gains are based on <b>Notes earned this run</b>. Ink persists.</div>
              <div class="muted smallSans mono" id="runNotesLine">Run Notes: 0</div>
              <div class="muted smallSans mono" id="lifetimeNotesLine">Lifetime Notes: 0</div>
              <div class="muted smallSans mono" id="patronLine">You have: 0 Patron(s) ‚Ä¢ Take-a-bow Gain: +0</div>
              <div class="muted smallSans mono" id="nextPatronInfo">Next Patron in: ‚Äî Notes</div>
            </div>
            <button class="primary" id="prestigeBtn">üôá Take a bow</button>
          </div>

          <div class="footer">
            <span class="mono" id="clock">‚Äî</span>
            <span class="muted">Real note art + parchment background + baton cursor enforced.</span>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>
          <span>Orchestra</span>
          <span class="seg" aria-label="Bulk buy mode">
            <span class="muted smallSans">Buy:</span>
            <button id="buy1"  class="active" data-buymode="1">x1</button>
            <button id="buy10" data-buymode="10">x10</button>
            <button id="buy100" data-buymode="100">x100</button>
            <button id="buyMax" data-buymode="max">Max</button>
          </span>
        </h2>
        <div class="content">
          <div class="muted smallSans" style="margin-bottom:8px;">
            Instruments are grouped by family. Each instrument has its own Upgrades dropdown.
          </div>

          <div class="familyStack" id="familyStack"></div>

          <div style="height:10px"></div>

          <details class="dropdown" id="inkDropdown">
            <summary>
              <span>Archive Upgrades (Ink ‚Äî permanent)</span>
              <span class="tag">Meta</span>
            </summary>
            <div class="detailsBody">
              <div class="table" id="inkUpgradeList"></div>
            </div>
          </details>

          <div class="footer">
            <span class="muted">Synergies boost whole families. Ladders boost individual instruments.</span>
            <span class="muted">Ink upgrades grow slowly, then compound.</span>
          </div>
        </div>
      </section>

    </div>
  </div>

  <div class="tab" id="tab-stats" hidden>
    <section class="card">
      <h2><span>Statistics</span><span class="tag">Read-only</span></h2>
      <div class="content">
        <div class="table" id="statsList"></div>
        <div class="footer">
          <span class="muted">Stats update live.</span>
          <span class="mono" id="statsClock">‚Äî</span>
        </div>
      </div>
    </section>
  </div>

  <div class="tab" id="tab-prestige" hidden>
    <section class="card">
      <h2><span>Performance Facility (Patrons)</span><span class="tag warn">Prestige Hall</span></h2>
      <div class="content">
        <div class="muted smallSans" style="margin-bottom:10px;">
          Spend Patrons to upgrade your facility. Patrons spent are gone, but facilities grant big global bonuses.
        </div>

        <div class="mini" style="margin-bottom:10px;">
          <div class="name">
            <div class="top">
              <b id="facilityName">‚Äî</b>
              <span class="tag warn" id="facilityBonus">‚Äî</span>
            </div>
            <div class="muted smallSans" id="facilityDesc">‚Äî</div>
          </div>
          <div class="right">
            <div class="cost mono" id="facilityPatrons">Patrons: ‚Äî</div>
            <div class="cost mono" id="facilityEarned">Earned: ‚Äî</div>
          </div>
        </div>

        <details class="dropdown" id="facilityUpgradesDetails">
          <summary>
            <span>Facility Upgrades</span>
            <span class="tag" id="facilityUpgradesTag">‚Äî</span>
          </summary>
          <div class="detailsBody">
            <div class="table" id="facilityUpgradesList"></div>
          </div>
        </details>

        <div style="height:10px"></div>

        <details class="dropdown" id="facilityNextDetails">
          <summary>
            <span>Move to a New Venue</span>
            <span class="tag" id="facilityNextTag">‚Äî</span>
          </summary>
          <div class="detailsBody">
            <div class="table" id="facilityNextList"></div>
          </div>
        </details>

        <div class="footer">
          <span class="muted">This hall appears after your first ‚ÄúTake a bow.‚Äù</span>
          <span class="mono" id="prestigeClock">‚Äî</span>
        </div>
      </div>
    </section>
  </div>

  <div class="tab" id="tab-settings" hidden>
    <section class="card">
      <h2><span>Settings</span><span class="tag warn">Be careful</span></h2>
      <div class="content">
        <label class="settingRow" for="settingSuffix">
          <input type="checkbox" id="settingSuffix"/>
          <span>Abbreviate numbers ‚â• 1,000,000 (4 sig figs: 1.000M, 10.00M, 1.000B‚Ä¶)</span>
        </label>

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <b>Save</b>
            <div class="muted smallSans">Autosave runs every 30 seconds, but you can save anytime.</div>
          </div>
          <button id="saveBtn">üíæ Save Now</button>
        </div>

        <div class="row">
          <div>
            <b>Hard Reset</b>
            <div class="muted smallSans">Erases everything (including Ink, Patrons, Facilities).</div>
          </div>
          <button class="danger" id="resetBtn">üß® Hard Reset</button>
        </div>

        <div class="footer">
          <span class="muted">Tip: We can add more quality-of-life settings anytime.</span>
          <span class="mono" id="settingsClock">‚Äî</span>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- Start screen -->
<div class="overlay" id="startOverlay" aria-hidden="true">
  <div class="veil"></div>
  <div class="startPanel">
    <div class="startCard">
      <h2 class="startTitle">Score Order Idle</h2>
      <p class="startSub">
        Conduct with your baton. Build an orchestra. Earn Ink (permanent).<br/>
        When you‚Äôre ready, <b>Take a bow</b> to court Patrons and begin again‚Äîstronger.
      </p>
      <div class="centerButtons">
        <button class="primary startBtn" id="startBtn">‚ñ∂ Start</button>
        <button id="startSkipBtn">Skip tutorial</button>
      </div>
      <div class="muted" style="margin-top:12px; font-size:12px;">
        Tip: This start screen only shows on your first playthrough (or after Hard Reset).
      </div>
    </div>
  </div>
</div>

<!-- Tutorial coach-marks -->
<div class="overlay" id="tutorialOverlay" aria-hidden="true">
  <div class="veil"></div>
  <div class="panel">
    <h3 id="tutTitle">‚Äî</h3>
    <div class="msg" id="tutMsg">‚Äî</div>
    <div class="actions">
      <button id="tutSkipBtn">Skip</button>
      <button class="primary" id="tutNextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Prestige explanation modal (first-run @ 500,000 run notes) -->
<div class="overlay" id="prestigeExplainOverlay" aria-hidden="true">
  <div class="veil"></div>
  <div class="panel">
    <h3>Prestige: ‚ÄúTake a bow‚Äù</h3>
    <div class="msg" style="margin-top:6px;">
      When you <b>Take a bow</b>, you reset your run (Notes, instruments, note-upgrades, synergies, baton techniques)‚Ä¶<br/>
      but you keep <b>Ink</b> and your <b>Archive Upgrades</b> permanently.<br/><br/>
      Your <b>Patron</b> gains are based on <b>Notes earned this run</b>. After you bow, you start earning Patrons from the beginning again (500,000 ‚Üí ‚Ä¶), while keeping all Patrons you‚Äôve already earned overall.<br/><br/>
      Patrons unlock your <b>Performance Facility</b>‚Äîbig global bonuses that grow over time.
    </div>
    <div class="actions">
      <button id="prestigeExplainGoHallBtn">Open Prestige Hall</button>
      <button class="primary" id="prestigeExplainOkBtn">Got it</button>
    </div>
  </div>
</div>

<script>
  // iOS Safari: prevent double-tap zoom on the main click target
  (() => {
    const btn = document.getElementById("noteBtn");
    if (!btn) return;

    let lastTouchEnd = 0;
    btn.addEventListener("touchend", (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
  })();

  // Safari/WebKit compositing bug: force a one-time repaint after first paint
  (function repaintKick(){
    const kick = () => {
      document.body.classList.add("repaint-kick");
      void document.body.offsetHeight;
      requestAnimationFrame(() => document.body.classList.remove("repaint-kick"));
    };
    window.addEventListener("load", kick, { once: true });
  })();

(() => {
  // ---------- Utilities ----------
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const now = ()=>Date.now();

  function fmtSig4Suffix(n){
    if (!isFinite(n)) return "‚àû";
    const abs = Math.abs(n);
    if (abs < 1_000_000) {
      return n.toLocaleString(undefined,{maximumFractionDigits:2});
    }
    const suffixes = [
      { v: 1e12, s: "T" },
      { v: 1e9,  s: "B" },
      { v: 1e6,  s: "M" },
    ];
    const pick = suffixes.find(x => abs >= x.v) || suffixes[suffixes.length-1];
    const scaled = n / pick.v;

    const digits = Math.floor(Math.log10(Math.abs(scaled))) + 1;
    const decimals = Math.max(0, 4 - digits);
    return `${scaled.toFixed(decimals)}${pick.s}`;
  }

  function fmtNotesHud(n, useSuffix){
    if (!isFinite(n)) return "‚àû";
    if (useSuffix) return fmtSig4Suffix(n);
    const abs = Math.abs(n);
    if (abs < 1000) return Math.floor(n).toString();
    const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No"];
    let u = -1, x = abs;
    while (x >= 1000 && u < units.length-1) { x/=1000; u++; }
    const val = (n/Math.pow(1000,u+1));
    return (val >= 100 ? val.toFixed(0) : val >= 10 ? val.toFixed(1) : val.toFixed(2)) + units[u];
  }

  function fmtExact(n, useSuffix){
    if (!isFinite(n)) return "‚àû";
    return useSuffix ? fmtSig4Suffix(n) : n.toLocaleString(undefined,{maximumFractionDigits:2});
  }

  function fmtPct(p){
    if (!isFinite(p)) return "‚Äî";
    return `${(p*100).toFixed(p >= 0.1 ? 1 : 2)}%`;
  }

  function toast(msg){
    const t = document.createElement("div");
    t.className = "t";
    t.textContent = msg;
    $("#toast").appendChild(t);
    setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(4px)"; t.style.transition="all .35s ease"; }, 2600);
    setTimeout(()=>t.remove(), 3200);
  }

  // ---------- Real Note Art (from /assets) ----------
  const NOTE_STAGES = [
    { id:"whole",         label:"Whole Note",        img:"assets/note-whole.png" },
    { id:"dottedHalf",    label:"Dotted Half",       img:"assets/note-half-dotted.png" },
    { id:"half",          label:"Half Note",         img:"assets/note-half.png" },
    { id:"dottedQuarter", label:"Dotted Quarter",    img:"assets/note-quarter-dotted.png" },
    { id:"quarter",       label:"Quarter Note",      img:"assets/note-quarter.png" },
    { id:"dottedEighth",  label:"Dotted Eighth",     img:"assets/note-eighth-dotted.png" },
    { id:"eighth",        label:"Eighth Note",       img:"assets/note-eighth.png" },
  ];

  function currentStage(){
    const idx = Math.max(0, Math.min(NOTE_STAGES.length-1, S.noteStageIdx || 0));
    return NOTE_STAGES[idx];
  }

  function noteMarkup(stage){
    const src = stage?.img || "assets/note-whole.png";
    const alt = stage?.label || "Note";
    return `<img class="noteImg" src="${src}" alt="${alt}" draggable="false">`;
  }

  const BATON_UPGRADES = [
    { id:"bt_fermata",     name:"Fermata Hold",           desc:"Upgrade to Dotted Half. Base click +1.",   costNotes: 75,      requireStage: 0, setStage: 1, extraBase: 1 },
    { id:"bt_cue",         name:"Confident Cue",          desc:"Upgrade to Half Note. Base click +2.",     costNotes: 450,     requireStage: 1, setStage: 2, extraBase: 2 },
    { id:"bt_crescendo",   name:"Crescendo Sweep",        desc:"Upgrade to Dotted Quarter. Base click +4.",costNotes: 2800,    requireStage: 2, setStage: 3, extraBase: 4 },
    { id:"bt_syncopation", name:"Gesture of Syncopation", desc:"Upgrade to Quarter Note. Base click +8.",  costNotes: 18000,   requireStage: 3, setStage: 4, extraBase: 8 },
    { id:"bt_ritardando",  name:"Ritardando Control",     desc:"Upgrade to Dotted Eighth. Base click +16.",costNotes: 120000,  requireStage: 4, setStage: 5, extraBase: 16 },
    { id:"bt_precision",   name:"Precision Flick",        desc:"Upgrade to Eighth Note. Base click +32.",  costNotes: 850000,  requireStage: 5, setStage: 6, extraBase: 32 },
  ];

  function batonBaseClick(){
    return 1 + (S.batonBaseExtra || 0);
  }

  // ---------- Buildings ----------
  const BUILDINGS = [
    { id:"piccolo",     name:"Piccolo",       family:"Winds",   baseCost: 15,     costMult: 1.15, nps: 0.1 },
    { id:"flute",       name:"Flute",         family:"Winds",   baseCost: 100,    costMult: 1.15, nps: 1   },
    { id:"oboe",        name:"Oboe",          family:"Winds",   baseCost: 1100,   costMult: 1.15, nps: 8   },
    { id:"enghorn",     name:"English Horn",  family:"Winds",   baseCost: 12000,  costMult: 1.15, nps: 47  },
    { id:"bassoon",     name:"Bassoon",       family:"Winds",   baseCost: 130000, costMult: 1.15, nps: 260 },
    { id:"clarinet",    name:"Clarinet",      family:"Winds",   baseCost: 1.4e6,  costMult: 1.15, nps: 1400},
    { id:"basscl",      name:"Bass Clarinet", family:"Winds",   baseCost: 2.0e7,  costMult: 1.15, nps: 7800},

    { id:"horn",        name:"Horn",          family:"Brass",   baseCost: 3.3e8,  costMult: 1.15, nps: 44000},
    { id:"trumpet",     name:"Trumpet",       family:"Brass",   baseCost: 5.1e9,  costMult: 1.15, nps: 260000},
    { id:"trombone",    name:"Trombone",      family:"Brass",   baseCost: 7.5e10, costMult: 1.15, nps: 1600000},
    { id:"tuba",        name:"Tuba",          family:"Brass",   baseCost: 1.0e12, costMult: 1.15, nps: 1.0e7},

    { id:"timpani",     name:"Timpani",       family:"Perc",    baseCost: 1.4e13, costMult: 1.15, nps: 6.5e7},
    { id:"perc",        name:"Percussion",    family:"Perc",    baseCost: 2.2e14, costMult: 1.15, nps: 4.0e8},

    { id:"harp",        name:"Harp",          family:"Other",   baseCost: 3.7e15, costMult: 1.15, nps: 2.5e9},
    { id:"piano",       name:"Piano/Celesta", family:"Other",   baseCost: 6.0e16, costMult: 1.15, nps: 1.6e10},

    { id:"vln1",        name:"Violin I",      family:"Strings", baseCost: 1.0e18, costMult: 1.15, nps: 1.0e11},
    { id:"vln2",        name:"Violin II",     family:"Strings", baseCost: 1.7e19, costMult: 1.15, nps: 7.0e11},
    { id:"viola",       name:"Viola",         family:"Strings", baseCost: 2.8e20, costMult: 1.15, nps: 5.0e12},
    { id:"cello",       name:"Cello",         family:"Strings", baseCost: 4.6e21, costMult: 1.15, nps: 3.6e13},
    { id:"bass",        name:"Bass",          family:"Strings", baseCost: 7.5e22, costMult: 1.15, nps: 2.6e14},
  ];

  const FAMILY_ORDER = [
    { id:"Winds",   label:"Woodwinds",  defaultOpen:true },
    { id:"Brass",   label:"Brass",      defaultOpen:false },
    { id:"Perc",    label:"Percussion", defaultOpen:false },
    { id:"Strings", label:"Strings",    defaultOpen:false },
    { id:"Other",   label:"Other",      defaultOpen:false },
  ];

  // ---------- NOTE Upgrades (per-building ladder) ----------
  const UPGRADE_MILESTONES = [1, 5, 10, 25, 50, 100, 200, 400];
  const UPGRADE_COST_MULTS = [7, 33, 160, 900, 5200, 30000, 180000, 1100000];
  const UPGRADE_NAME_TEMPLATES = [
    "Etude Book",
    "Better Pads",
    "Handcrafted Mouthpiece",
    "Sectional Rehearsals",
    "Masterclass Series",
    "Principal Auditions",
    "Touring Season",
    "Legendary Legacy"
  ];
  const noteUpgradeId = (buildingId, tierIdx) => `nu_${buildingId}_${tierIdx}`;
  function buildNoteUpgrades(){
    const upgrades = [];
    for (const b of BUILDINGS){
      for (let i=0;i<UPGRADE_MILESTONES.length;i++){
        const milestone = UPGRADE_MILESTONES[i];
        const mult = UPGRADE_COST_MULTS[i];
        upgrades.push({
          id: noteUpgradeId(b.id, i),
          buildingId: b.id,
          family: b.family,
          name: `${b.name}: ${UPGRADE_NAME_TEMPLATES[i]}`,
          desc: `${b.name} output x2 (requires ${milestone} owned)`,
          costNotes: Math.floor(b.baseCost * mult),
          requireOwned: milestone,
          apply: (s)=>{ s.buildingMult[b.id] *= 2; }
        });
      }
    }
    return upgrades;
  }
  const NOTE_UPGRADES = buildNoteUpgrades();

  // ---------- Section Synergy Upgrades (Notes) ----------
  function buildSynergyUpgrades(){
    const idsByFamily = (fam) => BUILDINGS.filter(b=>b.family===fam).map(b=>b.id);

    const WINDS = idsByFamily("Winds");
    const BRASS = idsByFamily("Brass");
    const STRINGS = idsByFamily("Strings");
    const PERC = idsByFamily("Perc");

    const groupCount = (s, ids) => ids.reduce((a,id)=>a+(s.owned[id]||0), 0);
    const groupBaseCostSum = (ids) => ids.reduce((a,id)=>a+(BUILDINGS.find(b=>b.id===id)?.baseCost||0), 0);

    const windsBase = groupBaseCostSum(WINDS);
    const brassBase = groupBaseCostSum(BRASS);
    const stringsBase = groupBaseCostSum(STRINGS);
    const percBase = groupBaseCostSum(PERC);

    const upgrades = [
      { id:"syn_winds_1", families:["Winds"], name:"Wind Consort", desc:"All Winds output +10%", costNotes: Math.floor(windsBase * 2.5),
        can: s => groupCount(s, WINDS) >= 25, apply: s => WINDS.forEach(id => s.buildingMult[id] *= 1.10) },
      { id:"syn_winds_2", families:["Winds"], name:"Woodwind Orchestra", desc:"All Winds output +25%", costNotes: Math.floor(windsBase * 10),
        can: s => groupCount(s, WINDS) >= 100, apply: s => WINDS.forEach(id => s.buildingMult[id] *= 1.25) },

      { id:"syn_brass_1", families:["Brass"], name:"Brass Choir", desc:"All Brass output +10%", costNotes: Math.floor(brassBase * 2.5),
        can: s => groupCount(s, BRASS) >= 25, apply: s => BRASS.forEach(id => s.buildingMult[id] *= 1.10) },
      { id:"syn_brass_2", families:["Brass"], name:"Symphonic Brass", desc:"All Brass output +25%", costNotes: Math.floor(brassBase * 10),
        can: s => groupCount(s, BRASS) >= 100, apply: s => BRASS.forEach(id => s.buildingMult[id] *= 1.25) },

      { id:"syn_strings_1", families:["Strings"], name:"String Section", desc:"All Strings output +10%", costNotes: Math.floor(stringsBase * 2.5),
        can: s => groupCount(s, STRINGS) >= 25, apply: s => STRINGS.forEach(id => s.buildingMult[id] *= 1.10) },
      { id:"syn_strings_2", families:["Strings"], name:"Philharmonic Strings", desc:"All Strings output +25%", costNotes: Math.floor(stringsBase * 10),
        can: s => groupCount(s, STRINGS) >= 100, apply: s => STRINGS.forEach(id => s.buildingMult[id] *= 1.25) },

      { id:"syn_perc_1", families:["Perc"], name:"Percussion Battery", desc:"All Percussion output +20%", costNotes: Math.floor(percBase * 3.5),
        can: s => groupCount(s, PERC) >= 10, apply: s => PERC.forEach(id => s.buildingMult[id] *= 1.20) },
      { id:"syn_perc_2", families:["Perc"], name:"Rhythmic Engine", desc:"All Percussion output +40%", costNotes: Math.floor(percBase * 14),
        can: s => groupCount(s, PERC) >= 50, apply: s => PERC.forEach(id => s.buildingMult[id] *= 1.40) },

      { id:"syn_doublereeds", families:["Winds"], name:"Double Reeds Studio",
        desc:"Oboe + English Horn + Bassoon output x2",
        costNotes: Math.floor((BUILDINGS.find(b=>b.id==="oboe").baseCost + BUILDINGS.find(b=>b.id==="enghorn").baseCost + BUILDINGS.find(b=>b.id==="bassoon").baseCost) * 120),
        can: s => ((s.owned.oboe||0) >= 10 && (s.owned.enghorn||0) >= 5 && (s.owned.bassoon||0) >= 10),
        apply: s => ["oboe","enghorn","bassoon"].forEach(id => s.buildingMult[id] *= 2) },

      { id:"syn_lowbrass", families:["Brass"], name:"Low Brass Foundation",
        desc:"Trombone + Tuba output +60%",
        costNotes: Math.floor((BUILDINGS.find(b=>b.id==="trombone").baseCost + BUILDINGS.find(b=>b.id==="tuba").baseCost) * 35),
        can: s => ((s.owned.trombone||0) >= 10 && (s.owned.tuba||0) >= 10),
        apply: s => ["trombone","tuba"].forEach(id => s.buildingMult[id] *= 1.60) },
    ];

    upgrades.forEach(u => u._can = u.can);
    upgrades.forEach(u => u.can = (s)=>u._can(s));
    return upgrades;
  }
  const SYNERGY_UPGRADES = buildSynergyUpgrades();

  // ---------- Ink (meta) Upgrades ----------
  function buildInkUpgrades(){
    const ups = [];

    const npsSteps = [
      {cost:10,  mult:1.001, name:"Margin Notes", desc:"+0.1% Notes/sec permanently"},
      {cost:25,  mult:1.002, name:"Clean Copy",   desc:"+0.2% Notes/sec permanently"},
      {cost:60,  mult:1.005, name:"Illuminated Initials", desc:"+0.5% Notes/sec permanently"},
      {cost:140, mult:1.01,  name:"Scribe Guild", desc:"+1% Notes/sec permanently"},
      {cost:320, mult:1.02,  name:"Royal Archive", desc:"+2% Notes/sec permanently"},
      {cost:800, mult:1.05,  name:"Endowment", desc:"+5% Notes/sec permanently"},
    ];
    npsSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_nps_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.metaNpsMult *= s.mult; }
      });
    });

    const clickFromNpsSteps = [
      {cost:25,  rate:0.001, name:"Quick Quill",  desc:"Each click gains +0.1% of your current Notes/sec"},
      {cost:90,  rate:0.002, name:"Scribe Reflex",desc:"Each click gains +0.2% of your current Notes/sec"},
      {cost:260, rate:0.005, name:"Ink & Tempo",  desc:"Each click gains +0.5% of your current Notes/sec"},
      {cost:900, rate:0.01,  name:"Virtuoso Penmanship", desc:"Each click gains +1% of your current Notes/sec"},
    ];
    clickFromNpsSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_clicknps_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.clickFromNpsRate += s.rate; }
      });
    });

    const clickMultSteps = [
      {cost:40,  mult:1.02, name:"Sharper Quill", desc:"+2% click power permanently"},
      {cost:150, mult:1.05, name:"Steel Nib",     desc:"+5% click power permanently"},
      {cost:600, mult:1.12, name:"Gold Nib",      desc:"+12% click power permanently"},
      {cost:2500,mult:1.30, name:"Mythic Pen",    desc:"+30% click power permanently"},
    ];
    clickMultSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_clickmult_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.metaClickMult *= s.mult; }
      });
    });

    return ups;
  }
  const INK_UPGRADES = buildInkUpgrades();

  // ---------- Facilities (Prestige Spending) ----------
  const FACILITY_BASE = [
    { id:"shed",    name:"Mildewy Shed",  desc:"A cramped shed behind the school. The stands wobble if you breathe too hard.",            patronCostToUnlock: 0,    globalMult:{ nps:1.00, click:1.00 } },
    { id:"garage",  name:"One-Car Garage",desc:"Still echoey‚Ä¶ but weatherproof, and you can fit a full section inside.",                  patronCostToUnlock: 100,  globalMult:{ nps:1.40, click:1.15 } },
    { id:"bandroom",name:"Band Room",     desc:"Lockers. Posters. A metronome that survived three directors. It feels like home.",         patronCostToUnlock: 250,  globalMult:{ nps:1.85, click:1.25 } },
    { id:"gym",     name:"Gymnasium",     desc:"Huge, loud, unforgiving‚Ä¶ but you can finally hear the low brass.",                         patronCostToUnlock: 600,  globalMult:{ nps:1.40, click:1.35 } },
    { id:"pac",     name:"School PAC",    desc:"Real lights. Real stage. Real applause (and stagehands who judge setup time).",            patronCostToUnlock: 1200, globalMult:{ nps:3.25, click:1.55 } },
    { id:"church",  name:"Stone Church",  desc:"Natural reverb for days. Every chord sounds like it means something.",                      patronCostToUnlock: 2200, globalMult:{ nps:4.30, click:1.75 } },
    { id:"hall",    name:"Concert Hall",  desc:"Perfect sightlines. Perfect acoustics. Suddenly‚Ä¶ you‚Äôre doing real work.",                 patronCostToUnlock: 4000, globalMult:{ nps:6.00, click:2.05 } },
    { id:"famous",  name:"Famous Venue",  desc:"This is where the legends played. The score practically writes itself.",               patronCostToUnlock: 8000, globalMult:{ nps:9.00, click:2.60 } },
  ];

  const FACILITY_UPGRADE_TEMPLATES = [
    { key:"stands",     name:"Engraved Stands",         kind:"nps"  },
    { key:"podium",     name:"Carved Podium",           kind:"click"},
    { key:"lighting",   name:"Warm Stage Lighting",     kind:"nps"  },
    { key:"acoustics",  name:"Acoustic Treatment",      kind:"nps"  },
    { key:"library",    name:"Score Library Catalog",   kind:"both" },
    { key:"tech",       name:"Stage Tech Crew",         kind:"click"},
    { key:"rehearsal",  name:"Sectional Program",       kind:"nps"  },
    { key:"recording",  name:"Recording Rig",           kind:"both" },
    { key:"patrons",    name:"Patron Experience",       kind:"nps"  },
  ];

  function buildFacilities(){
    const upgradesFor = (facId, nextCost) => {
      const percents = [0.05,0.06,0.07,0.08,0.09,0.10,0.11,0.13,0.15];
      const ups = [];
      for (let i=0;i<FACILITY_UPGRADE_TEMPLATES.length;i++){
        const t = FACILITY_UPGRADE_TEMPLATES[i];
        const pct = percents[i];
        const cost = Math.max(1, Math.round(nextCost * pct));
        const npsMult = 1 + pct * 2.2;
        const clickMult = 1 + pct * 1.6;

        let mult = {};
        let desc = "";
        if (t.kind === "nps"){
          mult = { nps: +(npsMult.toFixed(3)) };
          desc = `+${Math.round((npsMult-1)*100)}% Notes/sec`;
        } else if (t.kind === "click"){
          mult = { click: +(clickMult.toFixed(3)) };
          desc = `+${Math.round((clickMult-1)*100)}% Click power`;
        } else {
          mult = { nps: +( (1 + pct*1.5).toFixed(3) ), click: +( (1 + pct*1.1).toFixed(3) ) };
          desc = `+${Math.round((mult.nps-1)*100)}% Notes/sec & +${Math.round((mult.click-1)*100)}% Click`;
        }

        ups.push({
          id:`${facId}_${t.key}`,
          name:t.name,
          cost,
          desc,
          mult
        });
      }
      return ups;
    };

    const facilities = [];
    for (let i=0;i<FACILITY_BASE.length;i++){
      const f = FACILITY_BASE[i];
      const next = FACILITY_BASE[i+1];
      const nextCost = next ? next.patronCostToUnlock : Math.max(1000, Math.round(f.patronCostToUnlock * 1.5));
      facilities.push({
        ...f,
        upgrades: upgradesFor(f.id, nextCost)
      });
    }
    return facilities;
  }

  const FACILITIES = buildFacilities();
  function getFacility(id){ return FACILITIES.find(f => f.id === id); }

  function facilityMults(s){
    const f = getFacility(s.facility.currentId);
    let nps = f?.globalMult?.nps ?? 1;
    let click = f?.globalMult?.click ?? 1;

    const purchased = s.facility.purchasedUpgrades || {};
    if (f){
      for (const up of f.upgrades){
        if (!purchased[up.id]) continue;
        if (up.mult?.nps) nps *= up.mult.nps;
        if (up.mult?.click) click *= up.mult.click;
      }
    }
    return { nps, click };
  }

  function canAffordPatrons(cost){ return (S.patrons || 0) >= cost; }
  function spendPatrons(cost){ S.patrons = Math.max(0, (S.patrons || 0) - cost); }

  function unlockFacility(id){
    const f = getFacility(id);
    if (!f) return;
    if (S.facility.unlocked[id]) return;
    if (!canAffordPatrons(f.patronCostToUnlock)) return;

    spendPatrons(f.patronCostToUnlock);
    S.facility.unlocked[id] = true;
    S.facility.currentId = id;
    toast(`Venue: ${f.name}`);
    save(false);
    renderAll();
  }

  function buyFacilityUpgrade(upgradeId){
    const f = getFacility(S.facility.currentId);
    if (!f) return;
    const up = f.upgrades.find(u => u.id === upgradeId);
    if (!up) return;
    if (S.facility.purchasedUpgrades[upgradeId]) return;
    if (!canAffordPatrons(up.cost)) return;

    spendPatrons(up.cost);
    S.facility.purchasedUpgrades[upgradeId] = true;
    toast(`Facility: ${up.name}`);
    save(false);
    renderAll();
  }

  // ---------- Prestige (Patrons reset ladder each run) ----------
  const patronBonus = (patrons) => (1 + patrons * 0.05);

  // same shape as before, but based on notes earned THIS RUN
  function patronsFromRun(runNotes){
    return Math.floor(Math.sqrt((runNotes || 0) / 500000));
  }
  function runNotesForPatrons(p){
    return (p * p) * 500000;
  }
  function runNotesUntilNextPatron(s){
    const possibleNow = patronsFromRun(s.runNotes || 0);
    const nextP = possibleNow + 1;
    const need = runNotesForPatrons(nextP);
    return Math.max(0, need - (s.runNotes || 0));
  }

  function prestigePreview(){
    const wouldEarnThisRun = patronsFromRun(S.runNotes || 0);
    const gain = Math.max(0, wouldEarnThisRun); // bow resets run, so you haven‚Äôt claimed any this run yet
    return { wouldEarnThisRun, gain };
  }

  function doPrestige(){
    if (isBlocked()) return;

    const { gain } = prestigePreview();
    if (gain <= 0){
      toast("No new Patrons yet. Keep composing.");
      return;
    }
    const ok = confirm(
      `‚ÄúTake a bow‚Äù will reset your run (Notes, instruments, NOTE-upgrades, Synergies, Baton Techniques).\n` +
      `You keep Ink + Archive upgrades + Facilities.\n\n` +
      `You will gain +${gain} Patron(s).\n\nProceed?`
    );
    if (!ok) return;

    S.patronsEver = (S.patronsEver || 0) + gain;
    S.patrons = (S.patrons || 0) + gain;

    // reset run
    S.notes = 0;
    S.runNotes = 0;

    S.owned = Object.fromEntries(BUILDINGS.map(b=>[b.id,0]));
    S.buildingMult = Object.fromEntries(BUILDINGS.map(b=>[b.id,1]));
    S.noteUpgrades = {};
    S.synergyUpgrades = {};

    S.runClickMult = 1;
    S.runNpsMult = 1;

    S.noteStageIdx = 0;
    S.batonUpgrades = {};
    S.batonBaseExtra = 0;

    // after first prestige, reveal Prestige tab
    if (!S.ui) S.ui = {};
    S.ui.hasPrestiged = true;

    toast(`You gained ${gain} Patron(s).`);
    save(false);
    setPrestigeTabVisibility();
    setTab("prestige");
    renderAll();
  }

  // ---------- State ----------
  const KEY = "score_order_idle_v9";
  const stateDefault = () => ({
    version: 9,
    notes: 0,
    lifetimeNotes: 0,
    runNotes: 0,                 // NEW: notes earned this run (used for patrons)
    ink: 0,
    patrons: 0,
    patronsEver: 0,
    owned: Object.fromEntries(BUILDINGS.map(b=>[b.id,0])),
    buildingMult: Object.fromEntries(BUILDINGS.map(b=>[b.id,1])),
    noteUpgrades: {},
    synergyUpgrades: {},
    runClickMult: 1,
    runNpsMult: 1,
    inkUpgrades: {},
    metaNpsMult: 1,
    metaClickMult: 1,
    clickFromNpsRate: 0,
    noteStageIdx: 0,
    batonUpgrades: {},
    batonBaseExtra: 0,
    facility: {
      currentId: "shed",
      unlocked: { shed: true },
      purchasedUpgrades: {}
    },
    buyMode: "1",
    ui: {
      tab: "main",
      familyOpen: {},
      instrumentUpOpen: {},
      synergyOpen: {},
      facilityUpOpen: false,
      facilityNextOpen: false,
      batonOpen: false,
      hasStarted: false,          // NEW: start screen gate
      tutorialCompleted: false,   // NEW
      tutorialStep: 0,            // NEW
      prestigeExplained: false,   // NEW
      blocked: false,             // NEW: modal pause
      hasPrestiged: false         // NEW: show prestige hall
    },
    settings: {
      abbrevLarge: true
    },
    stats: {
      clicks: 0,
      buildingsBought: 0,
      inkEarned: 0
    },
    lastTick: now(),
    lastSave: now(),
  });

  function load(){
    try{
      const raw =
        localStorage.getItem(KEY) ||
        localStorage.getItem("score_order_idle_v8") ||
        localStorage.getItem("score_order_idle_v7") ||
        localStorage.getItem("score_order_idle_v6") ||
        localStorage.getItem("score_order_idle_v5") ||
        localStorage.getItem("score_order_idle_v4") ||
        localStorage.getItem("score_order_idle_v3");

      if(!raw) return stateDefault();

      const s = JSON.parse(raw);
      const d = stateDefault();

      for (const k of Object.keys(d)){
        if (s[k] === undefined) s[k] = d[k];
      }

      if (!s.owned) s.owned = {};
      if (!s.buildingMult) s.buildingMult = {};
      for (const b of BUILDINGS){
        if (s.owned[b.id] === undefined) s.owned[b.id] = 0;
        if (s.buildingMult[b.id] === undefined) s.buildingMult[b.id] = 1;
      }

      if (!s.noteUpgrades) s.noteUpgrades = {};
      if (!s.synergyUpgrades) s.synergyUpgrades = {};
      if (!s.inkUpgrades) s.inkUpgrades = {};

      if (s.metaNpsMult === undefined) s.metaNpsMult = 1;
      if (s.metaClickMult === undefined) s.metaClickMult = 1;
      if (s.clickFromNpsRate === undefined) s.clickFromNpsRate = 0;

      if (!s.buyMode) s.buyMode = "1";

      if (!s.ui) s.ui = d.ui;
      if (!s.ui.familyOpen) s.ui.familyOpen = {};
      if (!s.ui.instrumentUpOpen) s.ui.instrumentUpOpen = {};
      if (!s.ui.synergyOpen) s.ui.synergyOpen = {};
      if (!s.ui.tab) s.ui.tab = "main";

      // NEW UI flags defaults
      if (s.ui.hasStarted === undefined) s.ui.hasStarted = false;
      if (s.ui.tutorialCompleted === undefined) s.ui.tutorialCompleted = false;
      if (s.ui.tutorialStep === undefined) s.ui.tutorialStep = 0;
      if (s.ui.prestigeExplained === undefined) s.ui.prestigeExplained = false;
      if (s.ui.blocked === undefined) s.ui.blocked = false;
      if (s.ui.hasPrestiged === undefined) s.ui.hasPrestiged = (s.patronsEver || 0) > 0;

      if (!s.settings) s.settings = d.settings;
      if (s.settings.abbrevLarge === undefined) s.settings.abbrevLarge = true;

      if (!s.stats) s.stats = d.stats;
      if (s.stats.clicks === undefined) s.stats.clicks = 0;
      if (s.stats.buildingsBought === undefined) s.stats.buildingsBought = 0;
      if (s.stats.inkEarned === undefined) s.stats.inkEarned = s.ink || 0;

      if (!s.facility) s.facility = d.facility;
      if (!s.facility.currentId) s.facility.currentId = "shed";
      if (!s.facility.unlocked) s.facility.unlocked = { shed: true };
      if (!s.facility.purchasedUpgrades) s.facility.purchasedUpgrades = {};

      if (s.patronsEver === undefined) s.patronsEver = s.patrons || 0;
      if (s.patrons === undefined) s.patrons = s.patronsEver;

      if (s.noteStageIdx === undefined) s.noteStageIdx = 0;
      if (!s.batonUpgrades) s.batonUpgrades = {};
      if (s.batonBaseExtra === undefined) s.batonBaseExtra = 0;

      // NEW: runNotes
      if (s.runNotes === undefined){
        // best effort: if this is an existing save, start runNotes at 0
        // so patrons ladder restarts cleanly next time
        s.runNotes = 0;
      }

      localStorage.setItem(KEY, JSON.stringify(s));
      return s;
    }catch(e){
      console.warn("Load failed", e);
      return stateDefault();
    }
  }

  let S = load();

  function save(showToast=true){
    S.lastSave = now();
    localStorage.setItem(KEY, JSON.stringify(S));
    if (showToast) toast("Saved.");
  }

  // ---------- Tutorial / Overlays ----------
  const startOverlay = $("#startOverlay");
  const tutOverlay = $("#tutorialOverlay");
  const prestigeExplainOverlay = $("#prestigeExplainOverlay");

  function isBlocked(){
    return !!S.ui.blocked || !S.ui.hasStarted || (tutOverlay.classList.contains("show")) || (startOverlay.classList.contains("show")) || (prestigeExplainOverlay.classList.contains("show"));
  }

  function clearHighlight(){
    $$(".tutorial-highlight").forEach(el => el.classList.remove("tutorial-highlight","noteBtn"));
  }

  function highlight(selector){
    clearHighlight();
    const el = $(selector);
    if (!el) return null;
    el.classList.add("tutorial-highlight");
    if (el.id === "noteBtn") el.classList.add("noteBtn");
    return el;
  }

  const TUTORIAL_STEPS = [
    {
      title: "Click the large note",
      msg: "Click the large whole note to gain Notes.",
      target: "#noteBtn",
      ensure: () => {}
    },
    {
      title: "Upgrade your conducting",
      msg: "Purchase Baton Techniques to upgrade your click power (and change the note symbol).",
      target: "#batonDropdown summary",
      ensure: () => { $("#batonDropdown").open = true; }
    },
    {
      title: "Start automatic production",
      msg: "Purchase instruments (start with Piccolo) to begin producing Notes every second.",
      target: "button[data-buy='piccolo']",
      ensure: () => {}
    },
    {
      title: "Ink is permanent",
      msg: "Every instrument you purchase gives Ink. Use Ink to buy permanent Archive Upgrades.",
      target: "#inkDropdown summary",
      ensure: () => { $("#inkDropdown").open = true; }
    }
  ];

  function showStartScreen(){
    startOverlay.classList.add("show");
    startOverlay.setAttribute("aria-hidden","false");
  }
  function hideStartScreen(){
    startOverlay.classList.remove("show");
    startOverlay.setAttribute("aria-hidden","true");
  }

  function showTutorial(){
    tutOverlay.classList.add("show");
    tutOverlay.setAttribute("aria-hidden","false");
    advanceTutorial(0, true);
  }
  function hideTutorial(){
    tutOverlay.classList.remove("show");
    tutOverlay.setAttribute("aria-hidden","true");
    clearHighlight();
  }

  function advanceTutorial(stepDelta=1, absolute=false){
    const max = TUTORIAL_STEPS.length;
    if (absolute) S.ui.tutorialStep = stepDelta;
    else S.ui.tutorialStep = (S.ui.tutorialStep || 0) + stepDelta;

    if (S.ui.tutorialStep >= max){
      S.ui.tutorialCompleted = true;
      S.ui.tutorialStep = 0;
      hideTutorial();
      save(false);
      renderAll();
      return;
    }

    const step = TUTORIAL_STEPS[S.ui.tutorialStep];
    if (!step) return;

    // ensure UI is rendered so targets exist
    renderAll();
    step.ensure();

    $("#tutTitle").textContent = step.title;
    $("#tutMsg").textContent = step.msg;

    // delay a tick so DOM is open/updated
    requestAnimationFrame(() => {
      step.ensure();
      highlight(step.target);
    });

    save(false);
  }

  function showPrestigeExplain(){
    S.ui.blocked = true;
    prestigeExplainOverlay.classList.add("show");
    prestigeExplainOverlay.setAttribute("aria-hidden","false");
    save(false);
  }
  function hidePrestigeExplain(){
    prestigeExplainOverlay.classList.remove("show");
    prestigeExplainOverlay.setAttribute("aria-hidden","true");
    S.ui.blocked = false;
    save(false);
  }

  $("#startBtn").addEventListener("click", ()=>{
    S.ui.hasStarted = true;
    hideStartScreen();
    // start tutorial unless already completed
    if (!S.ui.tutorialCompleted){
      showTutorial();
    }
    save(false);
    renderAll();
  });

  $("#startSkipBtn").addEventListener("click", ()=>{
    S.ui.hasStarted = true;
    S.ui.tutorialCompleted = true;
    S.ui.tutorialStep = 0;
    hideStartScreen();
    hideTutorial();
    save(false);
    renderAll();
  });

  $("#tutNextBtn").addEventListener("click", ()=> advanceTutorial(1,false));
  $("#tutSkipBtn").addEventListener("click", ()=>{
    S.ui.tutorialCompleted = true;
    S.ui.tutorialStep = 0;
    hideTutorial();
    save(false);
    renderAll();
  });

  $("#prestigeExplainOkBtn").addEventListener("click", ()=>{
    S.ui.prestigeExplained = true;
    hidePrestigeExplain();
    save(false);
    renderAll();
  });
  $("#prestigeExplainGoHallBtn").addEventListener("click", ()=>{
    S.ui.prestigeExplained = true;
    hidePrestigeExplain();
    S.ui.hasPrestiged = true; // reveal tab even if they haven't bowed yet (per your tutorial flow)
    setPrestigeTabVisibility();
    setTab("prestige");
    renderAll();
  });

  function setPrestigeTabVisibility(){
    const show = !!S.ui.hasPrestiged || (S.patronsEver || 0) > 0;
    const btn = $("#prestigeTabBtn");
    btn.hidden = !show;
  }

  // ---------- Economy ----------
  function buildingCostAtOwned(b, owned){
    return Math.floor(b.baseCost * Math.pow(b.costMult, owned));
  }

  function sumCostForK(b, k){
    const owned = S.owned[b.id] || 0;
    const r = b.costMult;
    const base = b.baseCost * Math.pow(r, owned);
    if (k <= 0) return 0;
    if (Math.abs(r - 1) < 1e-9) return Math.floor(base * k);
    const total = base * (Math.pow(r, k) - 1) / (r - 1);
    return Math.floor(total);
  }

  function maxAffordableCount(b){
    const owned = S.owned[b.id] || 0;
    const r = b.costMult;
    const budget = S.notes;

    const first = buildingCostAtOwned(b, owned);
    if (budget < first) return 0;

    const base = b.baseCost * Math.pow(r, owned);
    let kEst;
    if (Math.abs(r - 1) < 1e-9){
      kEst = Math.floor(budget / base);
    } else {
      const rhs = 1 + (budget * (r - 1) / base);
      kEst = Math.floor(Math.log(rhs) / Math.log(r));
    }
    kEst = Math.max(0, Math.min(1000000, kEst));

    while (kEst > 0 && sumCostForK(b, kEst) > budget) kEst--;
    while (sumCostForK(b, kEst + 1) <= budget) kEst++;

    return kEst;
  }

  function facilityNpsMultOnly(){
    return facilityMults(S).nps;
  }

  function globalNpsMultiplier(){
    return (S.runNpsMult * S.metaNpsMult * patronBonus(S.patrons) * facilityNpsMultOnly());
  }

  function baseInstrumentNps(b){
    const owned = S.owned[b.id] || 0;
    if (owned <= 0) return 0;
    const mult = (S.buildingMult[b.id] || 1);
    return owned * b.nps * mult;
  }

  function totalNps(){
    let sum = 0;
    for (const b of BUILDINGS){
      sum += baseInstrumentNps(b);
    }
    return sum * globalNpsMultiplier();
  }

  function effectiveInstrumentNps(b){
    return baseInstrumentNps(b) * globalNpsMultiplier();
  }

  function effectiveFamilyNps(familyId){
    let sum = 0;
    for (const b of BUILDINGS){
      if (b.family !== familyId) continue;
      sum += baseInstrumentNps(b);
    }
    return sum * globalNpsMultiplier();
  }

  function notesPerClick(){
    const nps = totalNps();
    const fromNps = S.clickFromNpsRate > 0 ? (S.clickFromNpsRate * nps) : 0;
    const fac = facilityMults(S);
    const base = batonBaseClick();
    return (((base * S.runClickMult) + fromNps) * S.metaClickMult * patronBonus(S.patrons)) * fac.click;
  }

  function buyBuilding(id, mode){
    if (isBlocked()) return false;

    const b = BUILDINGS.find(x=>x.id===id);
    if (!b) return false;

    let k = 1;
    if (mode === "10") k = 10;
    else if (mode === "100") k = 100;
    else if (mode === "max") k = maxAffordableCount(b);

    if (k <= 0) return false;

    const cost = sumCostForK(b, k);
    if (S.notes < cost) return false;

    S.notes -= cost;
    S.owned[id] = (S.owned[id]||0) + k;

    S.ink += k;
    S.stats.buildingsBought += k;
    S.stats.inkEarned += k;

    toast(`Added ${k} √ó ${b.name} (+${k} Ink).`);
    return true;
  }

  function buyNoteUpgrade(id){
    if (isBlocked()) return;

    const u = NOTE_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.noteUpgrades[id]) return;
    if ((S.owned[u.buildingId]||0) < u.requireOwned) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.noteUpgrades[id] = true;
    u.apply(S);
    toast(`Upgrade: ${u.name}`);
  }

  function buySynergyUpgrade(id){
    if (isBlocked()) return;

    const u = SYNERGY_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.synergyUpgrades[id]) return;
    if (!u.can(S)) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.synergyUpgrades[id] = true;
    u.apply(S);
    toast(`Synergy: ${u.name}`);
  }

  function buyInkUpgrade(id){
    if (isBlocked()) return;

    const u = INK_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.inkUpgrades[id]) return;
    if (S.ink < u.costInk) return;

    S.ink -= u.costInk;
    S.inkUpgrades[id] = true;
    u.apply(S);
    toast(`Archive: ${u.name}`);
  }

  function buyBatonUpgrade(id){
    if (isBlocked()) return;

    const u = BATON_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.batonUpgrades[id]) return;

    const stageIdx = S.noteStageIdx || 0;
    if (stageIdx < u.requireStage) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.batonUpgrades[id] = true;

    if (u.setStage !== undefined && u.setStage > stageIdx){
      S.noteStageIdx = u.setStage;
    }

    S.batonBaseExtra = (S.batonBaseExtra || 0) + (u.extraBase || 0);

    toast(`Baton: ${u.name}`);
  }

  // ‚úÖ Global ‚Äúmanual click‚Äù debounce (prevents double-fire from touch/click overlap)
  let lastManualClickAt = 0;

  function clickNote(){
    if (isBlocked()) return;

    const t = now();
    if (t - lastManualClickAt < 35) return; // ignore ultra-fast duplicates
    lastManualClickAt = t;

    const gain = notesPerClick();
    S.notes += gain;
    S.lifetimeNotes += gain;
    S.runNotes += gain;
    S.stats.clicks += 1;
  }

  // ‚úÖ FAST TAP (mobile) + click (desktop) wiring ‚Äî bound ONCE
  function wireNoteButtonOnce(){
    const btn = document.getElementById("noteBtn");
    if (!btn) return;
    if (btn._wiredFastTap) return;
    btn._wiredFastTap = true;

    let lastFast = 0;

    const doClick = () => {
      clickNote();
      renderHUD();
    };

    const fastTap = (e) => {
      e.preventDefault();
      lastFast = now();
      doClick();
    };

    btn.addEventListener("pointerdown", (e) => {
      if (e.pointerType === "mouse") return;
      fastTap(e);
    }, { passive: false });

    btn.addEventListener("touchstart", fastTap, { passive: false });

    btn.addEventListener("click", () => {
      if (now() - lastFast < 650) return;
      doClick();
    });
  }

  // ---------- Offline Progress ----------
  function applyOffline(){
    const t = now();
    const dt = (t - S.lastTick) / 1000;
    if (dt <= 2) return;

    const cap = 6 * 60 * 60;
    const used = Math.min(dt, cap);

    const gained = totalNps() * used;
    S.notes += gained;
    S.lifetimeNotes += gained;
    S.runNotes += gained;

    toast(`Welcome back! +${fmtExact(gained, S.settings.abbrevLarge)} Notes from ${Math.floor(used/60)}m offline.`);
  }

  // ---------- Tabs ----------
  let statsLiveTimer = null;

  function startStatsLive(){
    stopStatsLive();
    renderStats(); // refresh immediately on open
    statsLiveTimer = setInterval(() => {
      if (S.ui.tab !== "stats") return;
      renderStats();
      const timeStr = new Date().toLocaleString();
      $("#statsClock").textContent = timeStr;
    }, 250);
  }
  function stopStatsLive(){
    if (statsLiveTimer){
      clearInterval(statsLiveTimer);
      statsLiveTimer = null;
    }
  }

  function setTab(tab){
    S.ui.tab = tab;
    $("#tab-main").hidden = tab !== "main";
    $("#tab-stats").hidden = tab !== "stats";
    $("#tab-prestige").hidden = tab !== "prestige";
    $("#tab-settings").hidden = tab !== "settings";

    $$("button[data-tab]").forEach(b => b.classList.toggle("active", b.getAttribute("data-tab") === tab));

    // stats live update behavior
    if (tab === "stats") startStatsLive();
    else stopStatsLive();

    save(false);
  }
  $$("button[data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=> setTab(btn.getAttribute("data-tab")));
  });

  // ---------- UI Helpers ----------
  function setBuyMode(mode){
    S.buyMode = mode;
    ["buy1","buy10","buy100","buyMax"].forEach(id=>{
      const btn = $("#"+id);
      const m = btn.getAttribute("data-buymode");
      btn.classList.toggle("active", m === mode);
    });
    save(false);
    renderFamilies();
  }

  function instrumentLabelFamily(familyId){
    const f = FAMILY_ORDER.find(x=>x.id===familyId);
    return f ? f.label : familyId;
  }

  // ---------- Render ----------
  function renderHUD(){
    const nps = totalNps();
    const npc = notesPerClick();
    const useSuffix = !!S.settings.abbrevLarge;

    $("#notesHud").textContent = fmtNotesHud(S.notes, useSuffix);
    $("#npsHud").textContent = fmtExact(nps, useSuffix);
    $("#npcHud").textContent = fmtExact(npc, useSuffix);
    $("#inkHud").textContent = fmtNotesHud(S.ink, useSuffix);
    $("#patronsHud").textContent = fmtNotesHud(S.patrons, false);

    $("#bigNotes").textContent = `${fmtNotesHud(S.notes, useSuffix)} Notes`;
    $("#npsMini").textContent = fmtExact(nps, useSuffix);

    $("#inkBonusMini").textContent = `x${S.metaNpsMult.toFixed(3)}`;
    $("#patronBonusMini").textContent = `x${(1 + (S.patrons||0) * 0.05).toFixed(2)}`;

    $("#runNotesLine").textContent = `Run Notes: ${fmtNotesHud(S.runNotes || 0, useSuffix)}`;
    $("#lifetimeNotesLine").textContent = `Lifetime Notes: ${fmtNotesHud(S.lifetimeNotes, useSuffix)}`;

    const p = prestigePreview();
    $("#patronLine").textContent = `You have: ${S.patrons} Patron(s) ‚Ä¢ Take-a-bow Gain: +${p.gain}`;

    const rem = runNotesUntilNextPatron(S);
    $("#nextPatronInfo").textContent = `Next Patron in: ${fmtExact(rem, useSuffix)} Notes`;

    const st = currentStage();
    $("#noteBtn").innerHTML = noteMarkup(st);
    $("#batonTag").textContent = st.label;

    const timeStr = new Date().toLocaleString();
    $("#clock").textContent = timeStr;
    $("#statsClock").textContent = timeStr;
    $("#settingsClock").textContent = timeStr;
    const pc = $("#prestigeClock");
    if (pc) pc.textContent = timeStr;
  }

  function renderBatonUpgrades(){
    const el = $("#batonUpgradeList");
    el.innerHTML = "";
    const useSuffix = !!S.settings.abbrevLarge;

    const bd = $("#batonDropdown");
    bd.open = !!S.ui.batonOpen;
    if (!bd._bound){
      bd.addEventListener("toggle", ()=>{
        S.ui.batonOpen = bd.open;
        save(false);
      });
      bd._bound = true;
    }

    const stageIdx = S.noteStageIdx || 0;

    for (const u of BATON_UPGRADES){
      const owned = !!S.batonUpgrades[u.id];
      const unlocked = stageIdx >= u.requireStage;
      const afford = S.notes >= u.costNotes;

      const tagClass = owned ? "good" : unlocked ? (afford ? "warn" : "") : "bad";
      const tagText  = owned ? "Purchased" : unlocked ? "Unlocked" : `Need ${NOTE_STAGES[u.requireStage].label}`;

      const div = document.createElement("div");
      div.className = "mini" + (owned ? " purchased" : "");
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${tagClass}">${tagText}</span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
          ${
            owned ? "" : `
            <div class="muted smallSans mono afterPurchase" style="margin-top:4px;">
              After purchase: Base click = <b>${batonBaseClick() + u.extraBase}</b>
            </div>`
          }
        </div>
        <div class="right">
          <button data-bt="${u.id}" ${(!owned && unlocked && afford && !isBlocked()) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes, useSuffix)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-bt]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyBatonUpgrade(btn.getAttribute("data-bt"));
        renderAll();
      });
    });
  }

  function renderFamilies(){
    const stack = $("#familyStack");
    stack.innerHTML = "";
    const useSuffix = !!S.settings.abbrevLarge;

    const total = totalNps();

    for (const fam of FAMILY_ORDER){
      const famBuildings = BUILDINGS.filter(b => b.family === fam.id);
      if (famBuildings.length === 0) continue;

      const isOpen = (S.ui.familyOpen[fam.id] !== undefined) ? S.ui.familyOpen[fam.id] : fam.defaultOpen;

      const d = document.createElement("details");
      d.open = !!isOpen;

      d.addEventListener("toggle", ()=>{
        S.ui.familyOpen[fam.id] = d.open;
        save(false);
      });

      const ownedCount = famBuildings.reduce((a,b)=>a+(S.owned[b.id]||0),0);

      const famNps = effectiveFamilyNps(fam.id);
      const famPct = total > 0 ? (famNps / total) : 0;

      const ownedTag = `<span class="tag good">Owned: <span class="mono">${ownedCount}</span></span>`;
      const npsTag   = `<span class="tag">NPS: <span class="mono">${fmtExact(famNps, useSuffix)}</span> ‚Ä¢ <span class="mono">${fmtPct(famPct)}</span></span>`;

      d.innerHTML = `
        <summary>
          <span class="familyHeader">
            <span>${instrumentLabelFamily(fam.id)}</span>
            ${ownedTag}
            ${npsTag}
          </span>
          <span class="tag">${famBuildings.length} instruments</span>
        </summary>
        <div class="detailsBody">
          <div class="table" id="instList-${fam.id}"></div>
          <details class="dropdown" data-synfam="${fam.id}" ${(S.ui.synergyOpen[fam.id] ? "open" : "")}>
            <summary>
              <span>Section Synergies (Notes)</span>
              <span class="tag">${instrumentLabelFamily(fam.id)}</span>
            </summary>
            <div class="detailsBody">
              <div class="table" id="synList-${fam.id}"></div>
            </div>
          </details>
        </div>
      `;

      stack.appendChild(d);

      const synDetails = d.querySelector(`details[data-synfam="${fam.id}"]`);
      synDetails.addEventListener("toggle", ()=>{
        S.ui.synergyOpen[fam.id] = synDetails.open;
        save(false);
      });

      renderInstrumentsForFamily(fam.id);
      renderSynergyForFamily(fam.id);
    }
  }

  function renderInstrumentsForFamily(familyId){
    const el = document.getElementById(`instList-${familyId}`);
    if (!el) return;
    el.innerHTML = "";

    const useSuffix = !!S.settings.abbrevLarge;
    const buildings = BUILDINGS.filter(b=>b.family===familyId);

    const total = totalNps();

    for (const b of buildings){
      const owned = S.owned[b.id] || 0;

      let k = 1;
      if (S.buyMode === "10") k = 10;
      else if (S.buyMode === "100") k = 100;
      else if (S.buyMode === "max") k = maxAffordableCount(b);

      const cost = sumCostForK(b, k);
      const afford = (k > 0) && (S.notes >= cost) && !isBlocked();

      let perEachBase = b.nps * (S.buildingMult[b.id]||1);
      const instNps = effectiveInstrumentNps(b);
      const instPct = total > 0 ? (instNps / total) : 0;

      const label = (S.buyMode === "max") ? (k > 0 ? `Add Max (${k})` : "Add Max") : `Add x${k}`;

      const instOpen = (S.ui.instrumentUpOpen[b.id] !== undefined) ? S.ui.instrumentUpOpen[b.id] : false;

      const row = document.createElement("div");
      row.className = "mini";
      row.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${b.name}</b>
            <span class="tag good">Owned: <span class="mono">${owned}</span></span>
            <span class="tag">NPS: <span class="mono">${fmtExact(instNps, useSuffix)}</span> ‚Ä¢ <span class="mono">${fmtPct(instPct)}</span></span>
          </div>
          <div class="muted smallSans">
            Produces <span class="mono"><b>${fmtExact(perEachBase, useSuffix)}</b></span> Notes/sec each
            <span class="muted">(before global/meta/patrons)</span>
          </div>

          <details class="dropdown instrumentUpgrades" data-inst="${b.id}" ${instOpen ? "open" : ""} style="margin-top:10px;">
            <summary>
              <span>Upgrades (Notes)</span>
              <span class="tag">${b.name}</span>
            </summary>
            <div class="detailsBody">
              <div class="table" id="instUp-${b.id}"></div>
            </div>
          </details>
        </div>

        <div class="right">
          <button class="primary" data-buy="${b.id}" ${afford ? "" : "disabled"}>${label}</button>
          <div class="cost mono">Cost: ${k>0 ? fmtExact(cost, useSuffix) : "‚Äî"} Notes</div>
          <div class="cost">${k>0 ? `+${k} Ink` : "+0 Ink"}</div>
        </div>
      `;

      el.appendChild(row);

      row.querySelector(`button[data-buy="${b.id}"]`).addEventListener("click", ()=>{
        const ok = buyBuilding(b.id, S.buyMode);
        if (ok) renderAll();
      });

      const det = row.querySelector(`details[data-inst="${b.id}"]`);
      det.addEventListener("toggle", ()=>{
        S.ui.instrumentUpOpen[b.id] = det.open;
        save(false);
      });

      renderInstrumentUpgrades(b.id);
    }
  }

  function renderInstrumentUpgrades(buildingId){
    const el = document.getElementById(`instUp-${buildingId}`);
    if (!el) return;
    el.innerHTML = "";

    const useSuffix = !!S.settings.abbrevLarge;
    const relevant = NOTE_UPGRADES.filter(u => u.buildingId === buildingId)
      .filter(u=>{
        if (S.noteUpgrades[u.id]) return true;
        const owned = S.owned[u.buildingId] || 0;
        return owned >= Math.max(0, u.requireOwned - 4);
      });

    if (relevant.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted smallSans";
      empty.textContent = "Buy this instrument to unlock its first upgrades.";
      el.appendChild(empty);
      return;
    }

    for (const u of relevant){
      const owned = !!S.noteUpgrades[u.id];
      const have = S.owned[u.buildingId] || 0;
      const unlocked = have >= u.requireOwned;
      const afford = (S.notes >= u.costNotes) && !isBlocked();

      const tagClass = owned ? "good" : unlocked ? (afford ? "warn" : "") : "bad";
      const tagText = owned ? "Owned" : unlocked ? "Unlocked" : `Need ${u.requireOwned}`;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${tagClass}">${tagText}</span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-nu="${u.id}" ${(!owned && unlocked && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes, useSuffix)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-nu]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyNoteUpgrade(btn.getAttribute("data-nu"));
        renderAll();
      });
    });
  }

  function renderSynergyForFamily(familyId){
    const el = document.getElementById(`synList-${familyId}`);
    if (!el) return;
    el.innerHTML = "";

    const useSuffix = !!S.settings.abbrevLarge;
    const list = SYNERGY_UPGRADES.filter(u => (u.families || []).includes(familyId));
    if (list.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted smallSans";
      empty.textContent = "No synergies for this family yet.";
      el.appendChild(empty);
      return;
    }

    for (const u of list){
      const owned = !!S.synergyUpgrades[u.id];
      const can = u.can(S);
      const afford = (S.notes >= u.costNotes) && !isBlocked();

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${owned ? "good" : (can ? (afford ? "warn" : "") : "bad")}">
              ${owned ? "Owned" : (can ? "Available" : "Locked")}
            </span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-syn="${u.id}" ${(!owned && can && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes, useSuffix)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-syn]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buySynergyUpgrade(btn.getAttribute("data-syn"));
        renderAll();
      });
    });
  }

  function renderInkUpgrades(){
    const el = $("#inkUpgradeList");
    el.innerHTML = "";
    for (const u of INK_UPGRADES){
      const owned = !!S.inkUpgrades[u.id];
      const afford = (S.ink >= u.costInk) && !isBlocked();

      const div = document.createElement("div");
      div.className = "mini" + (owned ? " purchased" : "");
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${owned ? "good" : (afford ? "warn" : "")}">
              ${owned ? "Purchased" : (afford ? "Available" : "Locked")}
            </span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-iu="${u.id}" ${(!owned && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${u.costInk} Ink</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-iu]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyInkUpgrade(btn.getAttribute("data-iu"));
        renderAll();
      });
    });
  }

  function renderFacility(){
    const current = getFacility(S.facility.currentId);
    $("#facilityName").textContent = current ? current.name : "‚Äî";
    $("#facilityDesc").textContent = current ? current.desc : "‚Äî";

    const fac = facilityMults(S);
    $("#facilityBonus").textContent = `Global: x${fac.nps.toFixed(2)} NPS ‚Ä¢ x${fac.click.toFixed(2)} Click`;

    $("#facilityPatrons").textContent = `Patrons (available): ${S.patrons}`;
    $("#facilityEarned").textContent = `Patrons (earned): ${S.patronsEver}`;

    $("#facilityUpgradesTag").textContent = current ? current.name : "‚Äî";
    $("#facilityNextTag").textContent = "Venues";

    const fud = $("#facilityUpgradesDetails");
    fud.open = !!S.ui.facilityUpOpen;
    if (!fud._bound){
      fud.addEventListener("toggle", ()=>{ S.ui.facilityUpOpen = fud.open; save(false); });
      fud._bound = true;
    }

    const fnd = $("#facilityNextDetails");
    fnd.open = !!S.ui.facilityNextOpen;
    if (!fnd._bound){
      fnd.addEventListener("toggle", ()=>{ S.ui.facilityNextOpen = fnd.open; save(false); });
      fnd._bound = true;
    }

    const upEl = $("#facilityUpgradesList");
    upEl.innerHTML = "";
    if (!current){
      upEl.innerHTML = `<div class="muted smallSans">No facility.</div>`;
    } else {
      for (const up of current.upgrades){
        const owned = !!S.facility.purchasedUpgrades[up.id];
        const afford = canAffordPatrons(up.cost) && !isBlocked();

        const div = document.createElement("div");
        div.className = "mini";
        div.innerHTML = `
          <div class="name">
            <div class="top">
              <b>${up.name}${owned ? " ‚úÖ" : ""}</b>
              <span class="tag ${owned ? "good" : (afford ? "warn" : "")}">${owned ? "Owned" : (afford ? "Available" : "Costly")}</span>
            </div>
            <div class="muted smallSans">${up.desc}</div>
          </div>
          <div class="right">
            <button data-fup="${up.id}" ${(!owned && afford) ? "" : "disabled"}>Buy</button>
            <div class="cost mono">${up.cost} Patron(s)</div>
          </div>
        `;
        upEl.appendChild(div);
      }
      upEl.querySelectorAll("button[data-fup]").forEach(btn=>{
        btn.addEventListener("click", ()=> buyFacilityUpgrade(btn.getAttribute("data-fup")));
      });
    }

    const nextEl = $("#facilityNextList");
    nextEl.innerHTML = "";

    const currentIdx = FACILITIES.findIndex(f => f.id === S.facility.currentId);
    for (let i=0;i<FACILITIES.length;i++){
      const f = FACILITIES[i];
      if (S.facility.unlocked[f.id]) continue;
      if (currentIdx !== -1 && i < currentIdx) continue;

      const afford = canAffordPatrons(f.patronCostToUnlock) && !isBlocked();
      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${f.name}</b>
            <span class="tag ${afford ? "warn" : ""}">Unlock</span>
          </div>
          <div class="muted smallSans">${f.desc}</div>
          <div class="muted smallSans mono" style="margin-top:4px;">
            Bonus: x${f.globalMult.nps.toFixed(2)} NPS ‚Ä¢ x${f.globalMult.click.toFixed(2)} Click
          </div>
        </div>
        <div class="right">
          <button data-fac="${f.id}" ${afford ? "" : "disabled"}>Move</button>
          <div class="cost mono">${f.patronCostToUnlock} Patron(s)</div>
        </div>
      `;
      nextEl.appendChild(div);
    }

    if (nextEl.children.length === 0){
      const done = document.createElement("div");
      done.className = "muted smallSans";
      done.textContent = "All venues unlocked (for now).";
      nextEl.appendChild(done);
    } else {
      nextEl.querySelectorAll("button[data-fac]").forEach(btn=>{
        btn.addEventListener("click", ()=> unlockFacility(btn.getAttribute("data-fac")));
      });
    }
  }

  function renderStats(){
    const el = $("#statsList");
    el.innerHTML = "";
    const useSuffix = !!S.settings.abbrevLarge;

    const nps = totalNps();
    const npc = notesPerClick();

    const totalOwned = BUILDINGS.reduce((a,b)=>a+(S.owned[b.id]||0),0);
    const byFam = {};
    for (const fam of FAMILY_ORDER){
      byFam[fam.id] = BUILDINGS.filter(b=>b.family===fam.id).reduce((a,b)=>a+(S.owned[b.id]||0),0);
    }

    const p = prestigePreview();
    const fac = facilityMults(S);
    const currentFac = getFacility(S.facility.currentId);
    const st = currentStage();

    const rows = [
      { k:"Notes", v: fmtExact(S.notes, useSuffix) },
      { k:"Notes/sec", v: fmtExact(nps, useSuffix) },
      { k:"Notes/click", v: fmtExact(npc, useSuffix) },
      { k:"Run Notes", v: fmtExact(S.runNotes || 0, useSuffix) },
      { k:"Lifetime Notes", v: fmtExact(S.lifetimeNotes, useSuffix) },
      { k:"Ink (current)", v: fmtExact(S.ink, false) },
      { k:"Patrons (available)", v: fmtExact(S.patrons, false) },
      { k:"Patrons (earned)", v: fmtExact(S.patronsEver, false) },
      { k:"Take-a-bow preview", v: `Gain +${p.gain} (based on this run)` },
      { k:"Next Patron (run notes remaining)", v: fmtExact(runNotesUntilNextPatron(S), useSuffix) },
      { k:"Clicks (lifetime)", v: fmtExact(S.stats.clicks || 0, false) },
      { k:"Instruments owned (total)", v: fmtExact(totalOwned, false) },
      { k:"Owned: Woodwinds", v: fmtExact(byFam.Winds || 0, false) },
      { k:"Owned: Brass", v: fmtExact(byFam.Brass || 0, false) },
      { k:"Owned: Percussion", v: fmtExact(byFam.Perc || 0, false) },
      { k:"Owned: Strings", v: fmtExact(byFam.Strings || 0, false) },
      { k:"Owned: Other", v: fmtExact(byFam.Other || 0, false) },
      { k:"Facility", v: currentFac ? currentFac.name : "‚Äî" },
      { k:"Facility mults", v: `x${fac.nps.toFixed(2)} NPS ‚Ä¢ x${fac.click.toFixed(2)} Click` },
      { k:"Baton stage (visual)", v: `${st.label}` },
      { k:"Baton base click", v: `${batonBaseClick()}` },
    ];

    for (const r of rows){
      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top"><b>${r.k}</b></div>
          <div class="muted smallSans mono">${r.v}</div>
        </div>
        <div class="right">
          <span class="tag">Stats</span>
        </div>
      `;
      el.appendChild(div);
    }
  }

  function renderSettings(){
    $("#settingSuffix").checked = !!S.settings.abbrevLarge;
  }

  function renderAll(){
    setPrestigeTabVisibility();
    renderHUD();
    renderBatonUpgrades();
    renderFamilies();
    renderInkUpgrades();
    renderFacility();
    if (S.ui.tab === "stats") renderStats();
    renderSettings();
  }

  let lastHeavy = 0;
  function tick(){
    const t = now();

    // If blocked by tutorial/modal/start screen, keep clocks fresh but pause game gain
    if (isBlocked()){
      S.lastTick = t;
      renderHUD();
      return;
    }

    let dt = (t - S.lastTick) / 1000;
    S.lastTick = t;
    dt = Math.min(dt, 0.25);

    const gained = totalNps() * dt;
    if (gained > 0){
      S.notes += gained;
      S.lifetimeNotes += gained;
      S.runNotes += gained;
    }

    // First-run prestige explanation (when they hit 500,000 run notes)
    if (!S.ui.prestigeExplained && (S.patronsEver || 0) === 0 && (S.runNotes || 0) >= 500000){
      showPrestigeExplain();
      renderHUD();
      return;
    }

    if (t - S.lastSave > 30000){
      S.lastSave = t;
      localStorage.setItem(KEY, JSON.stringify(S));
    }

    renderHUD();

    if (t - lastHeavy > 900){
      lastHeavy = t;
      renderBatonUpgrades();
      renderFamilies();
      renderInkUpgrades();
      renderFacility();
      if (S.ui.tab === "stats") renderStats();
    }
  }

  // ---------- Wire Buttons (ONCE) ----------
  wireNoteButtonOnce();

  $("#prestigeBtn").addEventListener("click", ()=>{
    doPrestige();
  });

  $("#saveBtn").addEventListener("click", ()=> save(true));

  // ‚úÖ Hard Reset: clone note button (kills duplicate handlers) + reset click debounce timer
  $("#resetBtn").addEventListener("click", ()=>{
    const ok = confirm("Hard reset will erase your save completely (including Ink, Patrons, Facilities). Are you sure?");
    if (!ok) return;

    localStorage.removeItem(KEY);
    localStorage.removeItem("score_order_idle_v9");
    localStorage.removeItem("score_order_idle_v8");
    localStorage.removeItem("score_order_idle_v7");
    localStorage.removeItem("score_order_idle_v6");
    localStorage.removeItem("score_order_idle_v5");
    localStorage.removeItem("score_order_idle_v4");
    localStorage.removeItem("score_order_idle_v3");

    S = stateDefault();

    // replace the note button node to guarantee only one set of listeners
    const oldBtn = document.getElementById("noteBtn");
    if (oldBtn && oldBtn.parentNode){
      const fresh = oldBtn.cloneNode(true);
      oldBtn.parentNode.replaceChild(fresh, oldBtn);
    }

    lastManualClickAt = 0;
    wireNoteButtonOnce();

    stopStatsLive();
    toast("Reset complete.");

    // show start screen again after reset
    showStartScreen();
    renderAll();
  });

  document.querySelectorAll("button[data-buymode]").forEach(btn=>{
    btn.addEventListener("click", ()=> setBuyMode(btn.getAttribute("data-buymode")));
  });

  $("#settingSuffix").addEventListener("change", (e)=>{
    S.settings.abbrevLarge = !!e.target.checked;
    save(false);
    renderAll();
  });

  // ---------- Boot ----------
  applyOffline();
  setBuyMode(S.buyMode);
  setPrestigeTabVisibility();
  setTab(S.ui.tab || "main");
  renderAll();
  setInterval(tick, 100);

  // Start screen / tutorial trigger
  if (!S.ui.hasStarted){
    showStartScreen();
  } else if (!S.ui.tutorialCompleted && !tutOverlay.classList.contains("show")){
    // If they started before but never finished tutorial, let them keep playing;
    // tutorial can be re-triggered later if desired. (No forced pop-up here.)
  }

  // Small toast only if already started
  if (S.ui.hasStarted && S.lifetimeNotes === 0 && S.notes === 0){
    toast("Click the note to start conducting!");
  }
})();
</script>
</body>
</html>
