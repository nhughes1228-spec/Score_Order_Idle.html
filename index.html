<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manuscript Note Clicker</title>
  <style>
    :root{
      --ink:#1e1a16;
      --ink2:#2b241e;
      --muted:#5a4f45;
      --paper:#f3e7cf;
      --paper2:#eadbbd;
      --line:rgba(35,29,24,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.22);
      --radius:16px;
      --accent:#2c6e7a;
      --accent2:#6b3c2a;
      --good:#1d7a41;
      --warn:#8a5a00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(44,110,122,.14), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(107,60,42,.10), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
    }
    /* subtle manuscript staff lines */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.22;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(35,29,24,.09) 0px,
          rgba(35,29,24,.09) 1px,
          transparent 1px,
          transparent 10px
        );
      mix-blend-mode:multiply;
    }
    header{
      padding:16px 16px 12px;
      position:sticky; top:0; z-index:5;
      background: linear-gradient(to bottom, rgba(243,231,207,.94), rgba(243,231,207,.78));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .hud{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      background: rgba(255,255,255,.45);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      box-shadow: 0 8px 22px rgba(0,0,0,.10);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .pill b{font-size:13px}
    main{padding:16px; max-width:1200px; margin:0 auto}
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(255,255,255,.55);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:14px; letter-spacing:.3px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.40);
      display:flex; align-items:center; justify-content:space-between;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .content{padding:12px 14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(35,29,24,.18)}
    .row:last-child{border-bottom:none}
    .muted{color:var(--muted)}
    button{
      background: rgba(255,255,255,.60);
      color:var(--ink2);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:800;
      letter-spacing:.2px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    button:hover{background: rgba(255,255,255,.80); border-color: rgba(44,110,122,.35)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .primary{
      background: linear-gradient(135deg, rgba(44,110,122,.18), rgba(255,255,255,.65));
      border-color: rgba(44,110,122,.32);
    }
    .danger{border-color: rgba(160,60,60,.30)}
    .table{display:flex; flex-direction:column; gap:8px}
    .mini{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 10px;
      background: rgba(255,255,255,.42);
      border: 1px solid rgba(35,29,24,.16);
      border-radius: 14px;
    }
    .mini .name{display:flex; flex-direction:column; gap:2px}
    .top{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(35,29,24,.18);
      color:var(--muted);
      background: rgba(255,255,255,.55);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .tag.good{color:var(--good); border-color: rgba(29,122,65,.22); background: rgba(29,122,65,.06)}
    .tag.warn{color:var(--warn); border-color: rgba(138,90,0,.22); background: rgba(138,90,0,.06)}
    .right{display:flex; flex-direction:column; gap:6px; align-items:flex-end; justify-content:center}
    .cost{font-size:12px; color:var(--muted); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .clickZone{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; padding:16px 0 6px;
    }
    .noteBtn{
      width:220px; height:220px;
      border-radius: 999px;
      display:grid; place-items:center;
      font-size:112px;
      user-select:none;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.88), rgba(255,255,255,.42));
      border:1px solid rgba(44,110,122,.26);
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
      color: var(--ink2);
    }
    .noteBtn:hover{border-color: rgba(44,110,122,.55)}
    .noteBtn:active{transform: translateY(2px)}
    .miniHud{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .toast{
      position:fixed; right:14px; bottom:14px;
      display:flex; flex-direction:column; gap:8px;
      max-width: 380px;
      z-index:10;
    }
    .toast .t{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(35,29,24,.20);
      border-left: 4px solid rgba(44,110,122,.75);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      font-size: 12px;
      color: var(--ink2);
      backdrop-filter: blur(6px);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .footer{
      margin-top:10px; padding:10px 14px;
      color: var(--muted); font-size:12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.35);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .inkSig{
      font-family: "Brush Script MT", "Snell Roundhand", "Apple Chancery", cursive;
      font-size: 18px;
      color: rgba(43,36,30,.85);
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Manuscript Note Clicker</h1>
    <div class="sub">Click ‚ô©, hire instruments (score order), earn Ink for upgrades, prestige for Patrons.</div>
  </div>
  <div class="hud">
    <div class="pill"><span class="muted">Notes</span> <b class="mono" id="notes">0</b></div>
    <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="nps">0</b></div>
    <div class="pill"><span class="muted">Click</span> <b class="mono" id="npc">1</b><span class="muted">/click</span></div>
    <div class="pill"><span class="muted">Ink</span> <b class="mono" id="ink">0</b></div>
    <div class="pill"><span class="muted">Patrons</span> <b class="mono" id="patrons">0</b></div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="card">
      <h2>
        <span>‚ô© The Note</span>
        <span class="tag good">Autosave: ON</span>
      </h2>
      <div class="content">
        <div class="clickZone">
          <button class="noteBtn" id="noteBtn" aria-label="Click the quarter note">‚ô©</button>
          <div class="miniHud">
            <div class="pill"><span class="muted">Lifetime</span> <b class="mono" id="lifetime">0</b></div>
            <div class="pill"><span class="muted">Prestige bonus</span> <b class="mono" id="prestigeBonus">x1.00</b></div>
          </div>
          <div class="muted" style="text-align:center; max-width:560px;">
            <span class="inkSig">In ink, we trust.</span>
            <div style="margin-top:6px;">
              Instruments generate Notes/sec. Patrons multiply all production permanently.
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <b>Sell Sheet Music</b>
            <div class="muted" style="font-size:12px">Convert 250 Notes into 1 Ink (Ink buys upgrades).</div>
          </div>
          <button id="sellBtn">üñãÔ∏è Sell (250‚Üí1)</button>
        </div>

        <div class="row">
          <div>
            <b>Prestige: Court Patrons</b>
            <div class="muted" style="font-size:12px">Reset run for permanent Patron bonus.</div>
          </div>
          <button class="primary" id="prestigeBtn">üé© Prestige</button>
        </div>

        <div class="row">
          <div>
            <b>Controls</b>
            <div class="muted" style="font-size:12px">Manual save, toggle auto-sell, reset.</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <button id="saveBtn">üíæ Save</button>
            <button id="toggleAutoSellBtn">üîÅ Auto-Sell: OFF</button>
            <button class="danger" id="resetBtn">üß® Hard Reset</button>
          </div>
        </div>

        <div class="footer">
          <span class="mono" id="clock">‚Äî</span>
          <span class="muted">Bug fix: store now re-renders continuously (no more ‚Äúonly updates after a click‚Äù).</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>
        <span>Orchestra</span>
        <span class="muted" style="font-size:12px">Buildings (Notes/sec)</span>
      </h2>
      <div class="content">
        <div class="table" id="buildingList"></div>

        <div style="height:10px"></div>

        <div class="muted" style="font-size:12px; margin-bottom:8px;">Upgrades (Ink)</div>
        <div class="table" id="upgradeList"></div>

        <div class="footer">
          <span class="muted">Score order early ‚Üí larger sections later ‚Üí percussion ‚Üí strings.</span>
          <span class="muted">Ink upgrades = big spikes.</span>
        </div>
      </div>
    </section>

  </div>
</main>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (sel)=>document.querySelector(sel);
  const now = ()=>Date.now();

  const fmt = (n) => {
    if (!isFinite(n)) return "‚àû";
    const abs = Math.abs(n);
    if (abs < 1000) return Math.floor(n).toString();
    const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No"];
    let u = -1, x = abs;
    while (x >= 1000 && u < units.length-1) { x/=1000; u++; }
    const val = (n/Math.pow(1000,u+1));
    return (val >= 100 ? val.toFixed(0) : val >= 10 ? val.toFixed(1) : val.toFixed(2)) + units[u];
  };
  const fmtExact = (n) => {
    if (!isFinite(n)) return "‚àû";
    return n.toLocaleString(undefined,{maximumFractionDigits:2});
  };

  function toast(msg){
    const t = document.createElement("div");
    t.className = "t";
    t.textContent = msg;
    $("#toast").appendChild(t);
    setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(4px)"; t.style.transition="all .35s ease"; }, 2600);
    setTimeout(()=>t.remove(), 3200);
  }

  // ---------- Buildings (in score-ish order) ----------
  // nps is per building; costs scale like Cookie Clicker
  const BUILDINGS = [
    { id:"piccolo",     name:"Piccolo",      family:"Winds",   baseCost: 15,     costMult: 1.15, nps: 0.1 },
    { id:"flute",       name:"Flute",        family:"Winds",   baseCost: 100,    costMult: 1.15, nps: 1   },
    { id:"oboe",        name:"Oboe",         family:"Winds",   baseCost: 1100,   costMult: 1.15, nps: 8   },
    { id:"enghorn",     name:"English Horn", family:"Winds",   baseCost: 12000,  costMult: 1.15, nps: 47  },
    { id:"bassoon",     name:"Bassoon",      family:"Winds",   baseCost: 130000, costMult: 1.15, nps: 260 },
    { id:"clarinet",    name:"Clarinet",     family:"Winds",   baseCost: 1.4e6,  costMult: 1.15, nps: 1400},
    { id:"basscl",      name:"Bass Clarinet",family:"Winds",   baseCost: 2.0e7,  costMult: 1.15, nps: 7800},

    { id:"horn",        name:"Horn",         family:"Brass",   baseCost: 3.3e8,  costMult: 1.15, nps: 44000},
    { id:"trumpet",     name:"Trumpet",      family:"Brass",   baseCost: 5.1e9,  costMult: 1.15, nps: 260000},
    { id:"trombone",    name:"Trombone",     family:"Brass",   baseCost: 7.5e10, costMult: 1.15, nps: 1600000},
    { id:"tuba",        name:"Tuba",         family:"Brass",   baseCost: 1.0e12, costMult: 1.15, nps: 1.0e7},

    { id:"timpani",     name:"Timpani",      family:"Perc",    baseCost: 1.4e13, costMult: 1.15, nps: 6.5e7},
    { id:"perc",        name:"Percussion",   family:"Perc",    baseCost: 2.2e14, costMult: 1.15, nps: 4.0e8},

    { id:"harp",        name:"Harp",         family:"Other",   baseCost: 3.7e15, costMult: 1.15, nps: 2.5e9},
    { id:"piano",       name:"Piano/Celesta",family:"Other",   baseCost: 6.0e16, costMult: 1.15, nps: 1.6e10},

    { id:"vln1",        name:"Violin I",     family:"Strings", baseCost: 1.0e18, costMult: 1.15, nps: 1.0e11},
    { id:"vln2",        name:"Violin II",    family:"Strings", baseCost: 1.7e19, costMult: 1.15, nps: 7.0e11},
    { id:"viola",       name:"Viola",        family:"Strings", baseCost: 2.8e20, costMult: 1.15, nps: 5.0e12},
    { id:"cello",       name:"Cello",        family:"Strings", baseCost: 4.6e21, costMult: 1.15, nps: 3.6e13},
    { id:"bass",        name:"Bass",         family:"Strings", baseCost: 7.5e22, costMult: 1.15, nps: 2.6e14},
  ];

  // ---------- Upgrades (Ink) ----------
  // Ink is an upgrade-only currency (fits the manuscript theme).
  const UPGRADES = [
    { id:"click1",  name:"Sharper Quill",      desc:"+1 Note/click", costInk: 5,
      can: s => true, apply: s => s.baseNpc += 1 },

    { id:"click2",  name:"Improved Engraving", desc:"+50% Notes/click", costInk: 20,
      can: s => s.upgrades.click1, apply: s => s.clickMult *= 1.5 },

    { id:"global1", name:"Rehearsal Schedule", desc:"+25% all Notes/sec", costInk: 12,
      can: s => true, apply: s => s.globalNpsMult *= 1.25 },

    { id:"global2", name:"Principal Chairs",   desc:"+35% all Notes/sec", costInk: 45,
      can: s => s.upgrades.global1, apply: s => s.globalNpsMult *= 1.35 },

    // a few ‚Äú10-owned‚Äù doubles
    { id:"dbl_flute", name:"Silver Headjoints", desc:"Flute output x2", costInk: 18,
      can: s => (s.owned.flute||0) >= 10, apply: s => s.buildingMult.flute *= 2 },

    { id:"dbl_horn", name:"Hand-Stopped Mastery", desc:"Horn output x2", costInk: 60,
      can: s => (s.owned.horn||0) >= 10, apply: s => s.buildingMult.horn *= 2 },

    { id:"dbl_vln1", name:"Section Leadership", desc:"Violin I output x2", costInk: 120,
      can: s => (s.owned.vln1||0) >= 10, apply: s => s.buildingMult.vln1 *= 2 },
  ];

  // ---------- Prestige ----------
  // Patrons are permanent. Each Patron adds +5% to all production.
  const patronBonus = (patrons) => (1 + patrons * 0.05);

  function patronsFromLifetime(lifetimeNotes){
    // Gentle curve. You‚Äôll see your first Patron reasonably early.
    // Feel free to tune: smaller divisor = faster Patrons.
    return Math.floor(Math.sqrt(lifetimeNotes / 500000));
  }

  // ---------- State ----------
  const KEY = "manuscript_note_clicker_v1";
  const stateDefault = () => ({
    version: 1,
    notes: 0,
    ink: 0,
    lifetimeNotes: 0,
    patrons: 0,

    owned: Object.fromEntries(BUILDINGS.map(b=>[b.id,0])),
    buildingMult: Object.fromEntries(BUILDINGS.map(b=>[b.id,1])),
    upgrades: {},

    baseNpc: 1,
    clickMult: 1,
    globalNpsMult: 1,

    autoSell: false,
    lastTick: now(),
    lastSave: now(),
  });

  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return stateDefault();
      const s = JSON.parse(raw);
      const d = stateDefault();

      for (const k of Object.keys(d)){
        if (s[k] === undefined) s[k] = d[k];
      }
      if (!s.owned) s.owned = {};
      if (!s.buildingMult) s.buildingMult = {};
      for (const b of BUILDINGS){
        if (s.owned[b.id] === undefined) s.owned[b.id] = 0;
        if (s.buildingMult[b.id] === undefined) s.buildingMult[b.id] = 1;
      }
      if (!s.upgrades) s.upgrades = {};
      return s;
    }catch(e){
      console.warn("Load failed", e);
      return stateDefault();
    }
  }

  let S = load();

  function save(){
    S.lastSave = now();
    localStorage.setItem(KEY, JSON.stringify(S));
    toast("Saved.");
  }

  // ---------- Economy ----------
  function buildingCost(b){
    const owned = S.owned[b.id] || 0;
    return Math.floor(b.baseCost * Math.pow(b.costMult, owned));
  }

  function totalNps(){
    let sum = 0;
    for (const b of BUILDINGS){
      const owned = S.owned[b.id] || 0;
      if (owned <= 0) continue;
      const mult = (S.buildingMult[b.id] || 1);
      sum += owned * b.nps * mult;
    }
    return sum * S.globalNpsMult * patronBonus(S.patrons);
  }

  function notesPerClick(){
    return (S.baseNpc * S.clickMult) * patronBonus(S.patrons);
  }

  function buyBuilding(id){
    const b = BUILDINGS.find(x=>x.id===id);
    if (!b) return;
    const cost = buildingCost(b);
    if (S.notes < cost) return;
    S.notes -= cost;
    S.owned[id] = (S.owned[id]||0) + 1;
    toast(`Added: ${b.name}.`);
  }

  function buyUpgrade(id){
    const u = UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.upgrades[id]) return;
    if (S.ink < u.costInk) return;
    if (!u.can(S)) return;
    S.ink -= u.costInk;
    S.upgrades[id] = true;
    u.apply(S);
    toast(`Upgrade: ${u.name}`);
  }

  function clickNote(){
    const gain = notesPerClick();
    S.notes += gain;
    S.lifetimeNotes += gain;
  }

  function sellNotesOnce(){
    const rate = 250;
    if (S.notes < rate) return false;
    S.notes -= rate;
    S.ink += 1;
    return true;
  }

  // ---------- Prestige ----------
  function prestigePreview(){
    const totalWouldHave = patronsFromLifetime(S.lifetimeNotes);
    const gain = Math.max(0, totalWouldHave - S.patrons);
    return { totalWouldHave, gain };
  }

  function doPrestige(){
    const { gain } = prestigePreview();
    if (gain <= 0){
      toast("No new Patrons yet. Bake‚Ä¶ uh‚Ä¶ compose more Notes.");
      return;
    }

    const ok = confirm(
      `Prestige will reset your current run (Notes, Ink, instruments, upgrades)\n` +
      `and award +${gain} Patron(s).\n\nProceed?`
    );
    if (!ok) return;

    // keep lifetimeNotes + patrons, reset the run economy
    S.patrons += gain;
    S.notes = 0;
    S.ink = 0;

    S.owned = Object.fromEntries(BUILDINGS.map(b=>[b.id,0]));
    S.buildingMult = Object.fromEntries(BUILDINGS.map(b=>[b.id,1]));
    S.upgrades = {};

    S.baseNpc = 1;
    S.clickMult = 1;
    S.globalNpsMult = 1;

    toast(`You gained ${gain} Patron(s). Production increased.`);
  }

  // ---------- Offline Progress ----------
  function applyOffline(){
    const t = now();
    const dt = (t - S.lastTick) / 1000;
    if (dt <= 2) return;

    const cap = 6 * 60 * 60;
    const used = Math.min(dt, cap);

    const gained = totalNps() * used;
    S.notes += gained;
    S.lifetimeNotes += gained;

    if (S.autoSell){
      const rate = 250;
      const sells = Math.floor(S.notes / rate);
      if (sells > 0){
        S.notes -= sells * rate;
        S.ink += sells;
      }
    }

    toast(`Welcome back! +${fmtExact(gained)} Notes from ${Math.floor(used/60)}m offline.`);
  }

  // ---------- UI ----------
  function renderHUD(){
    $("#notes").textContent = fmt(S.notes);
    $("#ink").textContent = fmt(S.ink);
    $("#patrons").textContent = fmt(S.patrons);
    $("#lifetime").textContent = fmt(S.lifetimeNotes);

    const nps = totalNps();
    $("#nps").textContent = fmtExact(nps);
    $("#npc").textContent = fmtExact(notesPerClick());

    $("#prestigeBonus").textContent = `x${patronBonus(S.patrons).toFixed(2)}`;
    $("#toggleAutoSellBtn").textContent = S.autoSell ? "üîÅ Auto-Sell: ON" : "üîÅ Auto-Sell: OFF";
    $("#clock").textContent = new Date().toLocaleString();
  }

  function renderBuildings(){
    const el = $("#buildingList");
    el.innerHTML = "";

    for (const b of BUILDINGS){
      const owned = S.owned[b.id] || 0;
      const cost = buildingCost(b);
      const afford = S.notes >= cost;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${b.name}</b>
            <span class="tag">${b.family}</span>
            <span class="tag good">Owned: <span class="mono">${owned}</span></span>
          </div>
          <div class="muted" style="font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;">
            Produces <span class="mono"><b>${fmtExact(b.nps * (S.buildingMult[b.id]||1))}</b></span> Notes/sec each
            <span class="muted">(before global + patrons)</span>
          </div>
        </div>
        <div class="right">
          <button class="primary" data-buy="${b.id}" ${afford ? "" : "disabled"}>Add</button>
          <div class="cost mono">Cost: ${fmtExact(cost)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-buy]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyBuilding(btn.getAttribute("data-buy"));
        renderAll(); // make sure affordability + ownership refresh immediately
      });
    });
  }

  function renderUpgrades(){
    const el = $("#upgradeList");
    el.innerHTML = "";

    for (const u of UPGRADES){
      const owned = !!S.upgrades[u.id];
      const can = u.can(S);
      const afford = S.ink >= u.costInk;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${owned ? "good" : (can ? "warn" : "")}">${owned ? "Owned" : (can ? "Available" : "Locked")}</span>
          </div>
          <div class="muted" style="font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;">
            ${u.desc}
          </div>
        </div>
        <div class="right">
          <button data-up="${u.id}" ${(!owned && can && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${u.costInk} Ink</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-up]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyUpgrade(btn.getAttribute("data-up"));
        renderAll();
      });
    });
  }

  function renderAll(){
    renderHUD();
    renderBuildings();
    renderUpgrades();
  }

  // ---------- Tick Loop ----------
  // FIX: re-render store continuously (throttled) so affordability updates without needing a click.
  let lastFullRender = 0;

  function tick(){
    const t = now();
    let dt = (t - S.lastTick) / 1000;
    S.lastTick = t;
    dt = Math.min(dt, 0.25);

    const gained = totalNps() * dt;
    if (gained > 0){
      S.notes += gained;
      S.lifetimeNotes += gained;
    }

    if (S.autoSell){
      // gradual autosell: up to 1 per tick
      if (S.notes >= 250) sellNotesOnce();
    }

    if (t - S.lastSave > 30000){
      S.lastSave = t;
      localStorage.setItem(KEY, JSON.stringify(S));
    }

    renderHUD();
    if (t - lastFullRender > 250){
      lastFullRender = t;
      renderBuildings();
      renderUpgrades();
    }
  }

  // ---------- Wire Buttons ----------
  $("#noteBtn").addEventListener("click", ()=>{
    clickNote();
    renderHUD(); // quick feedback
  });

  $("#sellBtn").addEventListener("click", ()=>{
    const ok = sellNotesOnce();
    toast(ok ? "Sold 250 Notes for 1 Ink." : "Need 250 Notes to sell.");
    renderAll();
  });

  $("#prestigeBtn").addEventListener("click", ()=>{
    const p = prestigePreview();
    if (p.gain <= 0){
      toast("No new Patrons yet ‚Äî keep building your lifetime Notes.");
      return;
    }
    doPrestige();
    renderAll();
  });

  $("#toggleAutoSellBtn").addEventListener("click", ()=>{
    S.autoSell = !S.autoSell;
    toast(S.autoSell ? "Auto-sell enabled." : "Auto-sell disabled.");
    renderHUD();
  });

  $("#saveBtn").addEventListener("click", save);

  $("#resetBtn").addEventListener("click", ()=>{
    const ok = confirm("Hard reset will erase your save completely. Are you sure?");
    if (!ok) return;
    localStorage.removeItem(KEY);
    S = stateDefault();
    toast("Reset complete.");
    renderAll();
  });

  // ---------- Boot ----------
  applyOffline();
  renderAll();
  setInterval(tick, 100);

  if (S.lifetimeNotes === 0 && S.notes === 0){
    toast("Click ‚ô© to start!");
  }
})();
</script>
</body>
</html>
