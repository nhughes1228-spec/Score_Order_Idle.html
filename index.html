<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Manuscript Note Clicker</title>
  <style>
    :root{
      --ink:#1e1a16;
      --ink2:#2b241e;
      --muted:#5a4f45;
      --paper:#f3e7cf;
      --paper2:#eadbbd;
      --line:rgba(35,29,24,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.22);
      --radius:16px;
      --accent:#2c6e7a;
      --accent2:#6b3c2a;
      --good:#1d7a41;
      --warn:#8a5a00;
      --bad:#a03c3c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(44,110,122,.14), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(107,60,42,.10), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.22;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(35,29,24,.09) 0px,
          rgba(35,29,24,.09) 1px,
          transparent 1px,
          transparent 10px
        );
      mix-blend-mode:multiply;
    }
    header{
      padding:16px 16px 12px;
      position:sticky; top:0; z-index:5;
      background: linear-gradient(to bottom, rgba(243,231,207,.94), rgba(243,231,207,.78));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    h1{margin:0; font-size:18px; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .hud{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .pill{
      background: rgba(255,255,255,.45);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      box-shadow: 0 8px 22px rgba(0,0,0,.10);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .pill b{font-size:13px}
    main{padding:16px; max-width:1200px; margin:0 auto}
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: rgba(255,255,255,.55);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:14px; letter-spacing:.3px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.40);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      flex-wrap:wrap;
    }
    .content{padding:12px 14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(35,29,24,.18)}
    .row:last-child{border-bottom:none}
    .muted{color:var(--muted)}
    button{
      background: rgba(255,255,255,.60);
      color:var(--ink2);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      font-weight:800;
      letter-spacing:.2px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      user-select:none;
    }
    button:hover{background: rgba(255,255,255,.80); border-color: rgba(44,110,122,.35)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .primary{
      background: linear-gradient(135deg, rgba(44,110,122,.18), rgba(255,255,255,.65));
      border-color: rgba(44,110,122,.32);
    }
    .danger{border-color: rgba(160,60,60,.30)}
    .table{display:flex; flex-direction:column; gap:8px}
    .mini{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px 10px;
      background: rgba(255,255,255,.42);
      border: 1px solid rgba(35,29,24,.16);
      border-radius: 14px;
    }
    .mini .name{display:flex; flex-direction:column; gap:2px}
    .top{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(35,29,24,.18);
      color:var(--muted);
      background: rgba(255,255,255,.55);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .tag.good{color:var(--good); border-color: rgba(29,122,65,.22); background: rgba(29,122,65,.06)}
    .tag.warn{color:var(--warn); border-color: rgba(138,90,0,.22); background: rgba(138,90,0,.06)}
    .tag.bad{color:var(--bad); border-color: rgba(160,60,60,.22); background: rgba(160,60,60,.06)}
    .right{display:flex; flex-direction:column; gap:6px; align-items:flex-end; justify-content:center}
    .cost{font-size:12px; color:var(--muted); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .mono{font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .clickZone{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; padding:16px 0 6px;
    }
    .noteBtn{
      width:220px; height:220px;
      border-radius: 999px;
      display:grid; place-items:center;
      font-size:112px;
      user-select:none;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.88), rgba(255,255,255,.42));
      border:1px solid rgba(44,110,122,.26);
      box-shadow: 0 20px 60px rgba(0,0,0,.20);
      color: var(--ink2);
    }
    .noteBtn:hover{border-color: rgba(44,110,122,.55)}
    .noteBtn:active{transform: translateY(2px)}
    .bigNotes{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 34px;
      color: rgba(43,36,30,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.55);
    }
    .miniHud{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .toast{
      position:fixed; right:14px; bottom:14px;
      display:flex; flex-direction:column; gap:8px;
      max-width: 420px;
      z-index:10;
    }
    .toast .t{
      background: rgba(255,255,255,.86);
      border:1px solid rgba(35,29,24,.20);
      border-left: 4px solid rgba(44,110,122,.75);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      font-size: 12px;
      color: var(--ink2);
      backdrop-filter: blur(6px);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .footer{
      margin-top:10px; padding:10px 14px;
      color: var(--muted); font-size:12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.35);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .inkSig{
      font-family: "Brush Script MT", "Snell Roundhand", "Apple Chancery", cursive;
      font-size: 18px;
      color: rgba(43,36,30,.85);
    }
    .smallSans{font-size:12px; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
    .seg{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .seg button{
      padding:7px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }
    .seg button.active{
      background: rgba(44,110,122,.18);
      border-color: rgba(44,110,122,.35);
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .tabs button{
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:900;
    }
    .tabs button.active{
      background: rgba(44,110,122,.18);
      border-color: rgba(44,110,122,.35);
    }
    .tab[hidden]{display:none !important}

    /* Collapsibles */
    details{
      border:1px solid rgba(35,29,24,.16);
      border-radius: 14px;
      background: rgba(255,255,255,.42);
      overflow:hidden;
    }
    details > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 10px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight:900;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      user-select:none;
    }
    details > summary::-webkit-details-marker{display:none}
    .detailsBody{padding:10px 10px; border-top:1px dashed rgba(35,29,24,.18)}
    .familyHeader{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .familyStack{display:flex; flex-direction:column; gap:10px}
    .dropdown{margin-top:10px}
    .settingRow{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px;
      border:1px solid rgba(35,29,24,.16);
      border-radius: 14px;
      background: rgba(255,255,255,.42);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      font-weight:800;
    }
    input[type="checkbox"]{transform: scale(1.15)}
    .dangerZone{
      border:1px solid rgba(160,60,60,.22);
      background: rgba(160,60,60,.06);
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Manuscript Note Clicker</h1>
    <div class="sub">Click ‚ô©, hire instruments (score order), Ink is meta, prestige for Patrons.</div>
  </div>

  <div class="hud">
    <div class="tabs" aria-label="Pages">
      <button class="active" data-tab="main">Main</button>
      <button data-tab="stats">Stats</button>
      <button data-tab="settings">Settings</button>
    </div>

    <div class="pill"><span class="muted">Notes</span> <b class="mono" id="notesHud">0</b></div>
    <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="npsHud">0</b></div>
    <div class="pill"><span class="muted">Click</span> <b class="mono" id="npcHud">1</b><span class="muted">/click</span></div>
    <div class="pill"><span class="muted">Ink</span> <b class="mono" id="inkHud">0</b></div>
    <div class="pill"><span class="muted">Patrons</span> <b class="mono" id="patronsHud">0</b></div>
  </div>
</header>

<main>
  <!-- MAIN TAB -->
  <div class="tab" id="tab-main">
    <div class="grid">

      <section class="card">
        <h2>
          <span>‚ô© The Note</span>
          <span class="tag good">Autosave: ON</span>
        </h2>
        <div class="content">
          <div class="clickZone">
            <button class="noteBtn" id="noteBtn" aria-label="Click the quarter note">‚ô©</button>

            <div class="bigNotes mono" id="bigNotes">0 Notes</div>

            <div class="miniHud">
              <div class="pill"><span class="muted">Notes/sec</span> <b class="mono" id="npsMini">0</b></div>
              <div class="pill"><span class="muted">Ink bonus</span> <b class="mono" id="inkBonusMini">x1.000</b></div>
              <div class="pill"><span class="muted">Patron bonus</span> <b class="mono" id="patronBonusMini">x1.00</b></div>
            </div>

            <div class="muted" style="text-align:center; max-width:560px;">
              <span class="inkSig">In ink, we trust.</span>
              <div class="smallSans" style="margin-top:6px;">
                Buy any instrument ‚Üí gain <b>+1 Ink</b> permanently. Notes buy instruments & upgrades.
              </div>
            </div>
          </div>

          <div class="row">
            <div>
              <b>Prestige: Court Patrons</b>
              <div class="muted smallSans">Lifetime Notes determine Patron gains. Ink persists.</div>
              <div class="muted smallSans mono" id="prestigeInfo">Lifetime: 0 ‚Ä¢ Gain: +0 Patron(s)</div>
              <div class="muted smallSans mono" id="nextPatronInfo">Next Patron in: ‚Äî Notes</div>
            </div>
            <button class="primary" id="prestigeBtn">üé© Prestige</button>
          </div>

          <div class="footer">
            <span class="mono" id="clock">‚Äî</span>
            <span class="muted">Families, dropdown upgrades, stats & settings enabled.</span>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>
          <span>Orchestra</span>
          <span class="seg" aria-label="Bulk buy mode">
            <span class="muted smallSans">Buy:</span>
            <button id="buy1"  class="active" data-buymode="1">x1</button>
            <button id="buy10" data-buymode="10">x10</button>
            <button id="buy100" data-buymode="100">x100</button>
            <button id="buyMax" data-buymode="max">Max</button>
          </span>
        </h2>
        <div class="content">
          <div class="muted smallSans" style="margin-bottom:8px;">
            Instruments are grouped by family. Each instrument has its own Upgrades dropdown.
          </div>

          <div class="familyStack" id="familyStack"></div>

          <div style="height:10px"></div>

          <details class="dropdown" id="inkDropdown">
            <summary>
              <span>Archive Upgrades (Ink ‚Äî permanent)</span>
              <span class="tag">Meta</span>
            </summary>
            <div class="detailsBody">
              <div class="table" id="inkUpgradeList"></div>
            </div>
          </details>

          <div class="footer">
            <span class="muted">Synergies boost whole families. Ladders boost individual instruments.</span>
            <span class="muted">Ink upgrades grow slowly, then compound.</span>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- STATS TAB -->
  <div class="tab" id="tab-stats" hidden>
    <section class="card">
      <h2><span>Statistics</span><span class="tag">Read-only</span></h2>
      <div class="content">
        <div class="table" id="statsList"></div>
        <div class="footer">
          <span class="muted">Stats update live. More coming soon (facility, note-value progression, etc.).</span>
          <span class="mono" id="statsClock">‚Äî</span>
        </div>
      </div>
    </section>
  </div>

  <!-- SETTINGS TAB -->
  <div class="tab" id="tab-settings" hidden>
    <section class="card">
      <h2><span>Settings</span><span class="tag warn">Be careful</span></h2>
      <div class="content">
        <label class="settingRow" for="settingSuffix">
          <input type="checkbox" id="settingSuffix"/>
          <span>Abbreviate numbers ‚â• 1,000,000 (4 sig figs: 1.000M, 10.00M, 1.000B‚Ä¶)</span>
        </label>

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <b>Save</b>
            <div class="muted smallSans">Autosave runs every 30 seconds, but you can save anytime.</div>
          </div>
          <button id="saveBtn">üíæ Save Now</button>
        </div>

        <div class="row">
          <div>
            <b>Hard Reset</b>
            <div class="muted smallSans">Erases everything (including Ink & Patrons).</div>
          </div>
          <button class="danger" id="resetBtn">üß® Hard Reset</button>
        </div>

        <div class="footer">
          <span class="muted">Tip: If you ever want a ‚Äúsoft reset‚Äù button later, we can add it too.</span>
          <span class="mono" id="settingsClock">‚Äî</span>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const now = ()=>Date.now();

  // 4 significant figures with M/B/T suffix (only for >= 1,000,000)
  function fmtSig4Suffix(n){
    if (!isFinite(n)) return "‚àû";
    const abs = Math.abs(n);
    if (abs < 1_000_000) {
      return n.toLocaleString(undefined,{maximumFractionDigits:2});
    }
    const suffixes = [
      { v: 1e12, s: "T" },
      { v: 1e9,  s: "B" },
      { v: 1e6,  s: "M" },
    ];
    const pick = suffixes.find(x => abs >= x.v) || suffixes[suffixes.length-1];
    const scaled = n / pick.v;

    // 4 significant figures
    const digits = Math.floor(Math.log10(Math.abs(scaled))) + 1;
    const decimals = Math.max(0, 4 - digits);
    return `${scaled.toFixed(decimals)}${pick.s}`;
  }

  // "Small" compact formatter for very large Notes in the HUD (keeps the game snappy)
  // If suffix mode is enabled, we still prefer the sig4 style above 1M.
  function fmtNotesHud(n, useSuffix){
    if (!isFinite(n)) return "‚àû";
    if (useSuffix) return fmtSig4Suffix(n);
    const abs = Math.abs(n);
    if (abs < 1000) return Math.floor(n).toString();
    const units = ["K","M","B","T","Qa","Qi","Sx","Sp","Oc","No"];
    let u = -1, x = abs;
    while (x >= 1000 && u < units.length-1) { x/=1000; u++; }
    const val = (n/Math.pow(1000,u+1));
    return (val >= 100 ? val.toFixed(0) : val >= 10 ? val.toFixed(1) : val.toFixed(2)) + units[u];
  }

  function fmtExact(n, useSuffix){
    if (!isFinite(n)) return "‚àû";
    return useSuffix ? fmtSig4Suffix(n) : n.toLocaleString(undefined,{maximumFractionDigits:2});
  }

  function toast(msg){
    const t = document.createElement("div");
    t.className = "t";
    t.textContent = msg;
    $("#toast").appendChild(t);
    setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(4px)"; t.style.transition="all .35s ease"; }, 2600);
    setTimeout(()=>t.remove(), 3200);
  }

  // ---------- Buildings (score-ish order) ----------
  const BUILDINGS = [
    { id:"piccolo",     name:"Piccolo",       family:"Winds",   baseCost: 15,     costMult: 1.15, nps: 0.1 },
    { id:"flute",       name:"Flute",         family:"Winds",   baseCost: 100,    costMult: 1.15, nps: 1   },
    { id:"oboe",        name:"Oboe",          family:"Winds",   baseCost: 1100,   costMult: 1.15, nps: 8   },
    { id:"enghorn",     name:"English Horn",  family:"Winds",   baseCost: 12000,  costMult: 1.15, nps: 47  },
    { id:"bassoon",     name:"Bassoon",       family:"Winds",   baseCost: 130000, costMult: 1.15, nps: 260 },
    { id:"clarinet",    name:"Clarinet",      family:"Winds",   baseCost: 1.4e6,  costMult: 1.15, nps: 1400},
    { id:"basscl",      name:"Bass Clarinet", family:"Winds",   baseCost: 2.0e7,  costMult: 1.15, nps: 7800},

    { id:"horn",        name:"Horn",          family:"Brass",   baseCost: 3.3e8,  costMult: 1.15, nps: 44000},
    { id:"trumpet",     name:"Trumpet",       family:"Brass",   baseCost: 5.1e9,  costMult: 1.15, nps: 260000},
    { id:"trombone",    name:"Trombone",      family:"Brass",   baseCost: 7.5e10, costMult: 1.15, nps: 1600000},
    { id:"tuba",        name:"Tuba",          family:"Brass",   baseCost: 1.0e12, costMult: 1.15, nps: 1.0e7},

    { id:"timpani",     name:"Timpani",       family:"Perc",    baseCost: 1.4e13, costMult: 1.15, nps: 6.5e7},
    { id:"perc",        name:"Percussion",    family:"Perc",    baseCost: 2.2e14, costMult: 1.15, nps: 4.0e8},

    { id:"harp",        name:"Harp",          family:"Other",   baseCost: 3.7e15, costMult: 1.15, nps: 2.5e9},
    { id:"piano",       name:"Piano/Celesta", family:"Other",   baseCost: 6.0e16, costMult: 1.15, nps: 1.6e10},

    { id:"vln1",        name:"Violin I",      family:"Strings", baseCost: 1.0e18, costMult: 1.15, nps: 1.0e11},
    { id:"vln2",        name:"Violin II",     family:"Strings", baseCost: 1.7e19, costMult: 1.15, nps: 7.0e11},
    { id:"viola",       name:"Viola",         family:"Strings", baseCost: 2.8e20, costMult: 1.15, nps: 5.0e12},
    { id:"cello",       name:"Cello",         family:"Strings", baseCost: 4.6e21, costMult: 1.15, nps: 3.6e13},
    { id:"bass",        name:"Bass",          family:"Strings", baseCost: 7.5e22, costMult: 1.15, nps: 2.6e14},
  ];

  const FAMILY_ORDER = [
    { id:"Winds",   label:"Woodwinds", defaultOpen:true },
    { id:"Brass",   label:"Brass",     defaultOpen:false },
    { id:"Perc",    label:"Percussion",defaultOpen:false },
    { id:"Strings", label:"Strings",   defaultOpen:false },
    { id:"Other",   label:"Other",     defaultOpen:false },
  ];

  // ---------- NOTE Upgrades (per-building ladder) ----------
  const UPGRADE_MILESTONES = [1, 5, 10, 25, 50, 100, 200, 400];
  const UPGRADE_COST_MULTS = [7, 33, 160, 900, 5200, 30000, 180000, 1100000];
  const UPGRADE_NAME_TEMPLATES = [
    "Etude Book",
    "Better Pads",
    "Handcrafted Mouthpiece",
    "Sectional Rehearsals",
    "Masterclass Series",
    "Principal Auditions",
    "Touring Season",
    "Legendary Legacy"
  ];

  const noteUpgradeId = (buildingId, tierIdx) => `nu_${buildingId}_${tierIdx}`;

  function buildNoteUpgrades(){
    const upgrades = [];
    for (const b of BUILDINGS){
      for (let i=0;i<UPGRADE_MILESTONES.length;i++){
        const milestone = UPGRADE_MILESTONES[i];
        const mult = UPGRADE_COST_MULTS[i];
        upgrades.push({
          id: noteUpgradeId(b.id, i),
          buildingId: b.id,
          family: b.family,
          name: `${b.name}: ${UPGRADE_NAME_TEMPLATES[i]}`,
          desc: `${b.name} output x2 (requires ${milestone} owned)`,
          costNotes: Math.floor(b.baseCost * mult),
          requireOwned: milestone,
          apply: (s)=>{ s.buildingMult[b.id] *= 2; }
        });
      }
    }
    return upgrades;
  }
  const NOTE_UPGRADES = buildNoteUpgrades();

  // ---------- Section Synergy Upgrades (Notes) ----------
  function buildSynergyUpgrades(){
    const idsByFamily = (fam) => BUILDINGS.filter(b=>b.family===fam).map(b=>b.id);

    const WINDS = idsByFamily("Winds");
    const BRASS = idsByFamily("Brass");
    const STRINGS = idsByFamily("Strings");
    const PERC = idsByFamily("Perc");

    const groupCount = (s, ids) => ids.reduce((a,id)=>a+(s.owned[id]||0), 0);
    const groupBaseCostSum = (ids) => ids.reduce((a,id)=>a+(BUILDINGS.find(b=>b.id===id)?.baseCost||0), 0);

    const windsBase = groupBaseCostSum(WINDS);
    const brassBase = groupBaseCostSum(BRASS);
    const stringsBase = groupBaseCostSum(STRINGS);
    const percBase = groupBaseCostSum(PERC);

    const upgrades = [
      // broad family boosts
      {
        id:"syn_winds_1",
        families:["Winds"],
        name:"Wind Consort",
        desc:"All Winds output +10%",
        costNotes: Math.floor(windsBase * 2.5),
        can: s => groupCount(s, WINDS) >= 25,
        apply: s => WINDS.forEach(id => s.buildingMult[id] *= 1.10)
      },
      {
        id:"syn_winds_2",
        families:["Winds"],
        name:"Woodwind Orchestra",
        desc:"All Winds output +25%",
        costNotes: Math.floor(windsBase * 10),
        can: s => groupCount(s, WINDS) >= 100,
        apply: s => WINDS.forEach(id => s.buildingMult[id] *= 1.25)
      },
      {
        id:"syn_brass_1",
        families:["Brass"],
        name:"Brass Choir",
        desc:"All Brass output +10%",
        costNotes: Math.floor(brassBase * 2.5),
        can: s => groupCount(s, BRASS) >= 25,
        apply: s => BRASS.forEach(id => s.buildingMult[id] *= 1.10)
      },
      {
        id:"syn_brass_2",
        families:["Brass"],
        name:"Symphonic Brass",
        desc:"All Brass output +25%",
        costNotes: Math.floor(brassBase * 10),
        can: s => groupCount(s, BRASS) >= 100,
        apply: s => BRASS.forEach(id => s.buildingMult[id] *= 1.25)
      },
      {
        id:"syn_strings_1",
        families:["Strings"],
        name:"String Section",
        desc:"All Strings output +10%",
        costNotes: Math.floor(stringsBase * 2.5),
        can: s => groupCount(s, STRINGS) >= 25,
        apply: s => STRINGS.forEach(id => s.buildingMult[id] *= 1.10)
      },
      {
        id:"syn_strings_2",
        families:["Strings"],
        name:"Philharmonic Strings",
        desc:"All Strings output +25%",
        costNotes: Math.floor(stringsBase * 10),
        can: s => groupCount(s, STRINGS) >= 100,
        apply: s => STRINGS.forEach(id => s.buildingMult[id] *= 1.25)
      },
      {
        id:"syn_perc_1",
        families:["Perc"],
        name:"Percussion Battery",
        desc:"All Percussion output +20%",
        costNotes: Math.floor(percBase * 3.5),
        can: s => groupCount(s, PERC) >= 10,
        apply: s => PERC.forEach(id => s.buildingMult[id] *= 1.20)
      },
      {
        id:"syn_perc_2",
        families:["Perc"],
        name:"Rhythmic Engine",
        desc:"All Percussion output +40%",
        costNotes: Math.floor(percBase * 14),
        can: s => groupCount(s, PERC) >= 50,
        apply: s => PERC.forEach(id => s.buildingMult[id] *= 1.40)
      },

      // specialty ‚Äúfun‚Äù synergies
      {
        id:"syn_doublereeds",
        families:["Winds"],
        name:"Double Reeds Studio",
        desc:"Oboe + English Horn + Bassoon output x2",
        costNotes: Math.floor((BUILDINGS.find(b=>b.id==="oboe").baseCost
                             + BUILDINGS.find(b=>b.id==="enghorn").baseCost
                             + BUILDINGS.find(b=>b.id==="bassoon").baseCost) * 120),
        can: s => ((s.owned.oboe||0) >= 10 && (s.owned.enghorn||0) >= 5 && (s.owned.bassoon||0) >= 10),
        apply: s => ["oboe","enghorn","bassoon"].forEach(id => s.buildingMult[id] *= 2)
      },
      {
        id:"syn_lowbrass",
        families:["Brass"],
        name:"Low Brass Foundation",
        desc:"Trombone + Tuba output +60%",
        costNotes: Math.floor((BUILDINGS.find(b=>b.id==="trombone").baseCost
                             + BUILDINGS.find(b=>b.id==="tuba").baseCost) * 35),
        can: s => ((s.owned.trombone||0) >= 10 && (s.owned.tuba||0) >= 10),
        apply: s => ["trombone","tuba"].forEach(id => s.buildingMult[id] *= 1.60)
      },
    ];

    upgrades.forEach(u => u._can = u.can);
    upgrades.forEach(u => u.can = (s)=>u._can(s));
    return upgrades;
  }
  const SYNERGY_UPGRADES = buildSynergyUpgrades();

  // ---------- Ink (meta) Upgrades ----------
  function buildInkUpgrades(){
    const ups = [];

    const npsSteps = [
      {cost:10,  mult:1.001, name:"Margin Notes", desc:"+0.1% Notes/sec permanently"},
      {cost:25,  mult:1.002, name:"Clean Copy",   desc:"+0.2% Notes/sec permanently"},
      {cost:60,  mult:1.005, name:"Illuminated Initials", desc:"+0.5% Notes/sec permanently"},
      {cost:140, mult:1.01,  name:"Scribe Guild", desc:"+1% Notes/sec permanently"},
      {cost:320, mult:1.02,  name:"Royal Archive", desc:"+2% Notes/sec permanently"},
      {cost:800, mult:1.05,  name:"Endowment", desc:"+5% Notes/sec permanently"},
    ];
    npsSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_nps_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.metaNpsMult *= s.mult; }
      });
    });

    const clickFromNpsSteps = [
      {cost:25,  rate:0.001, name:"Quick Quill",  desc:"Each click gains +0.1% of your current Notes/sec"},
      {cost:90,  rate:0.002, name:"Scribe Reflex",desc:"Each click gains +0.2% of your current Notes/sec"},
      {cost:260, rate:0.005, name:"Ink & Tempo",  desc:"Each click gains +0.5% of your current Notes/sec"},
      {cost:900, rate:0.01,  name:"Virtuoso Penmanship", desc:"Each click gains +1% of your current Notes/sec"},
    ];
    clickFromNpsSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_clicknps_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.clickFromNpsRate += s.rate; }
      });
    });

    const clickMultSteps = [
      {cost:40,  mult:1.02, name:"Sharper Quill", desc:"+2% click power permanently"},
      {cost:150, mult:1.05, name:"Steel Nib",     desc:"+5% click power permanently"},
      {cost:600, mult:1.12, name:"Gold Nib",      desc:"+12% click power permanently"},
      {cost:2500,mult:1.30, name:"Mythic Pen",    desc:"+30% click power permanently"},
    ];
    clickMultSteps.forEach((s, idx)=>{
      ups.push({
        id:`iu_clickmult_${idx}`,
        name:s.name,
        desc:s.desc,
        costInk:s.cost,
        can: st => true,
        apply: st => { st.metaClickMult *= s.mult; }
      });
    });

    return ups;
  }
  const INK_UPGRADES = buildInkUpgrades();

  // ---------- Prestige ----------
  const patronBonus = (patrons) => (1 + patrons * 0.05);
  function patronsFromLifetime(lifetimeNotes){
    return Math.floor(Math.sqrt(lifetimeNotes / 500000));
  }
  function lifetimeForPatrons(p){
    return (p * p) * 500000;
  }
  function notesUntilNextPatron(s){
    const nextP = (s.patrons || 0) + 1;
    const needLife = lifetimeForPatrons(nextP);
    return Math.max(0, needLife - (s.lifetimeNotes || 0));
  }

  // ---------- State ----------
  const KEY = "manuscript_note_clicker_v4";
  const stateDefault = () => ({
    version: 4,

    // run
    notes: 0,
    lifetimeNotes: 0,

    // permanent
    ink: 0,
    patrons: 0,

    // buildings (reset on prestige)
    owned: Object.fromEntries(BUILDINGS.map(b=>[b.id,0])),
    buildingMult: Object.fromEntries(BUILDINGS.map(b=>[b.id,1])),
    noteUpgrades: {},     // reset on prestige
    synergyUpgrades: {},  // reset on prestige

    // run multipliers (reset on prestige)
    baseNpc: 1,
    runClickMult: 1,
    runNpsMult: 1,

    // meta (permanent)
    inkUpgrades: {},
    metaNpsMult: 1,
    metaClickMult: 1,
    clickFromNpsRate: 0,

    // UI / Settings
    buyMode: "1", // "1" | "10" | "100" | "max"
    ui: {
      tab: "main",
      familyOpen: {},     // familyId -> bool
      instrumentUpOpen: {}// buildingId -> bool
    },
    settings: {
      abbrevLarge: true
    },

    // Stats
    stats: {
      clicks: 0,
      buildingsBought: 0,
      inkEarned: 0
    },

    lastTick: now(),
    lastSave: now(),
  });

  function load(){
    try{
      const rawOldV3 = localStorage.getItem("manuscript_note_clicker_v3");
      const rawV4 = localStorage.getItem(KEY);
      const raw = rawV4 || rawOldV3;
      if(!raw) return stateDefault();

      const s = JSON.parse(raw);
      const d = stateDefault();

      // shallow defaults
      for (const k of Object.keys(d)){
        if (s[k] === undefined) s[k] = d[k];
      }

      // deep defaults
      if (!s.owned) s.owned = {};
      if (!s.buildingMult) s.buildingMult = {};
      for (const b of BUILDINGS){
        if (s.owned[b.id] === undefined) s.owned[b.id] = 0;
        if (s.buildingMult[b.id] === undefined) s.buildingMult[b.id] = 1;
      }

      if (!s.noteUpgrades) s.noteUpgrades = {};
      if (!s.synergyUpgrades) s.synergyUpgrades = {};
      if (!s.inkUpgrades) s.inkUpgrades = {};

      if (s.metaNpsMult === undefined) s.metaNpsMult = 1;
      if (s.metaClickMult === undefined) s.metaClickMult = 1;
      if (s.clickFromNpsRate === undefined) s.clickFromNpsRate = 0;

      if (!s.buyMode) s.buyMode = "1";

      if (!s.ui) s.ui = d.ui;
      if (!s.ui.familyOpen) s.ui.familyOpen = {};
      if (!s.ui.instrumentUpOpen) s.ui.instrumentUpOpen = {};
      if (!s.ui.tab) s.ui.tab = "main";

      if (!s.settings) s.settings = d.settings;
      if (s.settings.abbrevLarge === undefined) s.settings.abbrevLarge = true;

      if (!s.stats) s.stats = d.stats;
      if (s.stats.clicks === undefined) s.stats.clicks = 0;
      if (s.stats.buildingsBought === undefined) s.stats.buildingsBought = 0;
      if (s.stats.inkEarned === undefined) s.stats.inkEarned = s.ink || 0;

      // migrate old key to new key once
      localStorage.setItem(KEY, JSON.stringify(s));
      return s;
    }catch(e){
      console.warn("Load failed", e);
      return stateDefault();
    }
  }

  let S = load();

  function save(showToast=true){
    S.lastSave = now();
    localStorage.setItem(KEY, JSON.stringify(S));
    if (showToast) toast("Saved.");
  }

  // ---------- Economy ----------
  function buildingCostAtOwned(b, owned){
    return Math.floor(b.baseCost * Math.pow(b.costMult, owned));
  }

  function sumCostForK(b, k){
    const owned = S.owned[b.id] || 0;
    const r = b.costMult;
    const base = b.baseCost * Math.pow(r, owned);
    if (k <= 0) return 0;
    if (Math.abs(r - 1) < 1e-9) return Math.floor(base * k);
    const total = base * (Math.pow(r, k) - 1) / (r - 1);
    return Math.floor(total);
  }

  function maxAffordableCount(b){
    const owned = S.owned[b.id] || 0;
    const r = b.costMult;
    const budget = S.notes;

    const first = buildingCostAtOwned(b, owned);
    if (budget < first) return 0;

    const base = b.baseCost * Math.pow(r, owned);
    let kEst;
    if (Math.abs(r - 1) < 1e-9){
      kEst = Math.floor(budget / base);
    } else {
      const rhs = 1 + (budget * (r - 1) / base);
      kEst = Math.floor(Math.log(rhs) / Math.log(r));
    }
    kEst = Math.max(0, Math.min(1000000, kEst));

    while (kEst > 0 && sumCostForK(b, kEst) > budget) kEst--;
    while (sumCostForK(b, kEst + 1) <= budget) kEst++;

    return kEst;
  }

  function totalNps(){
    let sum = 0;
    for (const b of BUILDINGS){
      const owned = S.owned[b.id] || 0;
      if (owned <= 0) continue;
      const mult = (S.buildingMult[b.id] || 1);
      sum += owned * b.nps * mult;
    }
    return sum * S.runNpsMult * S.metaNpsMult * patronBonus(S.patrons);
  }

  function notesPerClick(){
    const nps = totalNps();
    const fromNps = S.clickFromNpsRate > 0 ? (S.clickFromNpsRate * nps) : 0;
    return ((S.baseNpc * S.runClickMult) + fromNps) * S.metaClickMult * patronBonus(S.patrons);
  }

  function buyBuilding(id, mode){
    const b = BUILDINGS.find(x=>x.id===id);
    if (!b) return false;

    let k = 1;
    if (mode === "10") k = 10;
    else if (mode === "100") k = 100;
    else if (mode === "max") k = maxAffordableCount(b);

    if (k <= 0) return false;

    const cost = sumCostForK(b, k);
    if (S.notes < cost) return false;

    S.notes -= cost;
    S.owned[id] = (S.owned[id]||0) + k;

    // +1 Ink per building purchased (permanent)
    S.ink += k;
    S.stats.buildingsBought += k;
    S.stats.inkEarned += k;

    toast(`Added ${k} √ó ${b.name} (+${k} Ink).`);
    return true;
  }

  function buyNoteUpgrade(id){
    const u = NOTE_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.noteUpgrades[id]) return;
    if ((S.owned[u.buildingId]||0) < u.requireOwned) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.noteUpgrades[id] = true;
    u.apply(S);
    toast(`Upgrade: ${u.name}`);
  }

  function buySynergyUpgrade(id){
    const u = SYNERGY_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.synergyUpgrades[id]) return;
    if (!u.can(S)) return;
    if (S.notes < u.costNotes) return;

    S.notes -= u.costNotes;
    S.synergyUpgrades[id] = true;
    u.apply(S);
    toast(`Synergy: ${u.name}`);
  }

  function buyInkUpgrade(id){
    const u = INK_UPGRADES.find(x=>x.id===id);
    if (!u) return;
    if (S.inkUpgrades[id]) return;
    if (S.ink < u.costInk) return;
    if (!u.can(S)) return;

    S.ink -= u.costInk;
    S.inkUpgrades[id] = true;
    u.apply(S);
    toast(`Archive: ${u.name}`);
  }

  function clickNote(){
    const gain = notesPerClick();
    S.notes += gain;
    S.lifetimeNotes += gain;
    S.stats.clicks += 1;
  }

  // ---------- Prestige ----------
  function prestigePreview(){
    const totalWouldHave = patronsFromLifetime(S.lifetimeNotes);
    const gain = Math.max(0, totalWouldHave - S.patrons);
    return { totalWouldHave, gain };
  }

  function doPrestige(){
    const { gain } = prestigePreview();
    if (gain <= 0){
      toast("No new Patrons yet. Keep composing.");
      return;
    }
    const ok = confirm(
      `Prestige will reset your run (Notes, instruments, NOTE-upgrades, Synergies).\n` +
      `You keep Ink + Archive upgrades.\n\n` +
      `You will gain +${gain} Patron(s).\n\nProceed?`
    );
    if (!ok) return;

    S.patrons += gain;

    // reset run
    S.notes = 0;
    S.owned = Object.fromEntries(BUILDINGS.map(b=>[b.id,0]));
    S.buildingMult = Object.fromEntries(BUILDINGS.map(b=>[b.id,1]));
    S.noteUpgrades = {};
    S.synergyUpgrades = {};

    S.baseNpc = 1;
    S.runClickMult = 1;
    S.runNpsMult = 1;

    toast(`You gained ${gain} Patron(s).`);
  }

  // ---------- Offline Progress ----------
  function applyOffline(){
    const t = now();
    const dt = (t - S.lastTick) / 1000;
    if (dt <= 2) return;

    const cap = 6 * 60 * 60;
    const used = Math.min(dt, cap);

    const gained = totalNps() * used;
    S.notes += gained;
    S.lifetimeNotes += gained;

    toast(`Welcome back! +${fmtExact(gained, S.settings.abbrevLarge)} Notes from ${Math.floor(used/60)}m offline.`);
  }

  // ---------- Tabs ----------
  function setTab(tab){
    S.ui.tab = tab;
    $("#tab-main").hidden = tab !== "main";
    $("#tab-stats").hidden = tab !== "stats";
    $("#tab-settings").hidden = tab !== "settings";

    $$("button[data-tab]").forEach(b => b.classList.toggle("active", b.getAttribute("data-tab") === tab));
    save(false);
  }

  $$("button[data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=> setTab(btn.getAttribute("data-tab")));
  });

  // ---------- UI Helpers ----------
  function setBuyMode(mode){
    S.buyMode = mode;
    ["buy1","buy10","buy100","buyMax"].forEach(id=>{
      const btn = $("#"+id);
      const m = btn.getAttribute("data-buymode");
      btn.classList.toggle("active", m === mode);
    });
    save(false);
  }

  function instrumentLabelFamily(familyId){
    const f = FAMILY_ORDER.find(x=>x.id===familyId);
    return f ? f.label : familyId;
  }

  function renderHUD(){
    const nps = totalNps();
    const npc = notesPerClick();
    const useSuffix = !!S.settings.abbrevLarge;

    $("#notesHud").textContent = fmtNotesHud(S.notes, useSuffix);
    $("#npsHud").textContent = fmtExact(nps, useSuffix);
    $("#npcHud").textContent = fmtExact(npc, useSuffix);
    $("#inkHud").textContent = fmtNotesHud(S.ink, useSuffix);
    $("#patronsHud").textContent = fmtNotesHud(S.patrons, false);

    $("#bigNotes").textContent = `${fmtNotesHud(S.notes, useSuffix)} Notes`;
    $("#npsMini").textContent = fmtExact(nps, useSuffix);

    $("#inkBonusMini").textContent = `x${S.metaNpsMult.toFixed(3)}`;
    $("#patronBonusMini").textContent = `x${patronBonus(S.patrons).toFixed(2)}`;

    const p = prestigePreview();
    $("#prestigeInfo").textContent =
      `Lifetime: ${fmtNotesHud(S.lifetimeNotes, useSuffix)} ‚Ä¢ Gain: +${p.gain} Patron(s) ‚Ä¢ Total: ${p.totalWouldHave}`;

    const rem = notesUntilNextPatron(S);
    $("#nextPatronInfo").textContent =
      `Next Patron in: ${fmtExact(rem, useSuffix)} Notes`;

    const timeStr = new Date().toLocaleString();
    $("#clock").textContent = timeStr;
    $("#statsClock").textContent = timeStr;
    $("#settingsClock").textContent = timeStr;
  }

  // ---------- Family Render ----------
  function renderFamilies(){
    const stack = $("#familyStack");
    stack.innerHTML = "";

    for (const fam of FAMILY_ORDER){
      const famBuildings = BUILDINGS.filter(b => b.family === fam.id);
      if (famBuildings.length === 0) continue;

      // Default open states (Woodwinds open, others closed)
      const isOpen = (S.ui.familyOpen[fam.id] !== undefined) ? S.ui.familyOpen[fam.id] : fam.defaultOpen;

      const d = document.createElement("details");
      d.open = !!isOpen;

      d.addEventListener("toggle", ()=>{
        S.ui.familyOpen[fam.id] = d.open;
        save(false);
      });

      const ownedCount = famBuildings.reduce((a,b)=>a+(S.owned[b.id]||0),0);
      const sumTag = ownedCount > 0 ? `<span class="tag good">Owned: <span class="mono">${ownedCount}</span></span>` : `<span class="tag">Owned: <span class="mono">0</span></span>`;

      d.innerHTML = `
        <summary>
          <span class="familyHeader">
            <span>${instrumentLabelFamily(fam.id)}</span>
            ${sumTag}
          </span>
          <span class="tag">${famBuildings.length} instruments</span>
        </summary>
        <div class="detailsBody">
          <details class="dropdown" data-synfam="${fam.id}">
            <summary>
              <span>Section Synergies (Notes)</span>
              <span class="tag">${instrumentLabelFamily(fam.id)}</span>
            </summary>
            <div class="detailsBody">
              <div class="table" id="synList-${fam.id}"></div>
            </div>
          </details>

          <div style="height:10px"></div>
          <div class="table" id="instList-${fam.id}"></div>
        </div>
      `;

      stack.appendChild(d);

      renderSynergyForFamily(fam.id);
      renderInstrumentsForFamily(fam.id);
    }
  }

  function renderInstrumentsForFamily(familyId){
    const el = document.getElementById(`instList-${familyId}`);
    if (!el) return;
    el.innerHTML = "";

    const useSuffix = !!S.settings.abbrevLarge;
    const buildings = BUILDINGS.filter(b=>b.family===familyId);

    for (const b of buildings){
      const owned = S.owned[b.id] || 0;

      let k = 1;
      if (S.buyMode === "10") k = 10;
      else if (S.buyMode === "100") k = 100;
      else if (S.buyMode === "max") k = maxAffordableCount(b);

      const cost = sumCostForK(b, k);
      const afford = (k > 0) && (S.notes >= cost);

      const perEach = b.nps * (S.buildingMult[b.id]||1);
      const label = (S.buyMode === "max") ? (k > 0 ? `Add Max (${k})` : "Add Max") : `Add x${k}`;

      const instOpen = (S.ui.instrumentUpOpen[b.id] !== undefined) ? S.ui.instrumentUpOpen[b.id] : false;

      const row = document.createElement("div");
      row.className = "mini";
      row.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${b.name}</b>
            <span class="tag good">Owned: <span class="mono">${owned}</span></span>
          </div>
          <div class="muted smallSans">
            Produces <span class="mono"><b>${fmtExact(perEach, useSuffix)}</b></span> Notes/sec each
            <span class="muted">(before global/meta/patrons)</span>
          </div>

          <details class="dropdown instrumentUpgrades" data-inst="${b.id}" ${instOpen ? "open" : ""} style="margin-top:10px;">
            <summary>
              <span>Upgrades (Notes)</span>
              <span class="tag">${b.name}</span>
            </summary>
            <div class="detailsBody">
              <div class="table" id="instUp-${b.id}"></div>
            </div>
          </details>
        </div>

        <div class="right">
          <button class="primary" data-buy="${b.id}" ${afford ? "" : "disabled"}>${label}</button>
          <div class="cost mono">Cost: ${k>0 ? fmtExact(cost, useSuffix) : "‚Äî"} Notes</div>
          <div class="cost">${k>0 ? `+${k} Ink` : "+0 Ink"}</div>
        </div>
      `;

      el.appendChild(row);

      row.querySelector(`button[data-buy="${b.id}"]`).addEventListener("click", ()=>{
        const ok = buyBuilding(b.id, S.buyMode);
        if (ok) renderAll();
      });

      const det = row.querySelector(`details[data-inst="${b.id}"]`);
      det.addEventListener("toggle", ()=>{
        S.ui.instrumentUpOpen[b.id] = det.open;
        save(false);
      });

      renderInstrumentUpgrades(b.id);
    }
  }

  function renderInstrumentUpgrades(buildingId){
    const el = document.getElementById(`instUp-${buildingId}`);
    if (!el) return;
    el.innerHTML = "";

    const useSuffix = !!S.settings.abbrevLarge;
    const relevant = NOTE_UPGRADES.filter(u => u.buildingId === buildingId)
      .filter(u=>{
        if (S.noteUpgrades[u.id]) return true;
        const owned = S.owned[u.buildingId] || 0;
        return owned >= Math.max(0, u.requireOwned - 4);
      });

    if (relevant.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted smallSans";
      empty.textContent = "Buy this instrument to unlock its first upgrades.";
      el.appendChild(empty);
      return;
    }

    for (const u of relevant){
      const owned = !!S.noteUpgrades[u.id];
      const have = S.owned[u.buildingId] || 0;
      const unlocked = have >= u.requireOwned;
      const afford = S.notes >= u.costNotes;

      const tagClass = owned ? "good" : unlocked ? (afford ? "warn" : "") : "bad";
      const tagText = owned ? "Owned" : unlocked ? "Unlocked" : `Need ${u.requireOwned}`;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${tagClass}">${tagText}</span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-nu="${u.id}" ${(!owned && unlocked && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes, useSuffix)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-nu]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyNoteUpgrade(btn.getAttribute("data-nu"));
        renderAll();
      });
    });
  }

  function renderSynergyForFamily(familyId){
    const el = document.getElementById(`synList-${familyId}`);
    if (!el) return;
    el.innerHTML = "";

    const useSuffix = !!S.settings.abbrevLarge;
    const list = SYNERGY_UPGRADES.filter(u => (u.families || []).includes(familyId));
    if (list.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted smallSans";
      empty.textContent = "No synergies for this family yet.";
      el.appendChild(empty);
      return;
    }

    for (const u of list){
      const owned = !!S.synergyUpgrades[u.id];
      const can = u.can(S);
      const afford = S.notes >= u.costNotes;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${owned ? "good" : (can ? (afford ? "warn" : "") : "bad")}">
              ${owned ? "Owned" : (can ? "Available" : "Locked")}
            </span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-syn="${u.id}" ${(!owned && can && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${fmtExact(u.costNotes, useSuffix)} Notes</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-syn]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buySynergyUpgrade(btn.getAttribute("data-syn"));
        renderAll();
      });
    });
  }

  function renderInkUpgrades(){
    const el = $("#inkUpgradeList");
    el.innerHTML = "";
    const useSuffix = !!S.settings.abbrevLarge;

    for (const u of INK_UPGRADES){
      const owned = !!S.inkUpgrades[u.id];
      const can = u.can(S);
      const afford = S.ink >= u.costInk;

      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top">
            <b>${u.name}${owned ? " ‚úÖ" : ""}</b>
            <span class="tag ${owned ? "good" : (can ? (afford ? "warn" : "") : "bad")}">
              ${owned ? "Owned" : (can ? "Available" : "Locked")}
            </span>
          </div>
          <div class="muted smallSans">${u.desc}</div>
        </div>
        <div class="right">
          <button data-iu="${u.id}" ${(!owned && can && afford) ? "" : "disabled"}>Buy</button>
          <div class="cost mono">${u.costInk} Ink</div>
        </div>
      `;
      el.appendChild(div);
    }

    el.querySelectorAll("button[data-iu]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        buyInkUpgrade(btn.getAttribute("data-iu"));
        renderAll();
      });
    });
  }

  function renderStats(){
    const el = $("#statsList");
    el.innerHTML = "";
    const useSuffix = !!S.settings.abbrevLarge;

    const nps = totalNps();
    const npc = notesPerClick();

    const totalOwned = BUILDINGS.reduce((a,b)=>a+(S.owned[b.id]||0),0);
    const byFam = {};
    for (const fam of FAMILY_ORDER){
      byFam[fam.id] = BUILDINGS.filter(b=>b.family===fam.id).reduce((a,b)=>a+(S.owned[b.id]||0),0);
    }

    const p = prestigePreview();

    const rows = [
      { k:"Notes", v: fmtExact(S.notes, useSuffix) },
      { k:"Notes/sec", v: fmtExact(nps, useSuffix) },
      { k:"Notes/click", v: fmtExact(npc, useSuffix) },
      { k:"Lifetime Notes", v: fmtExact(S.lifetimeNotes, useSuffix) },
      { k:"Ink (current)", v: fmtExact(S.ink, false) },
      { k:"Ink earned (lifetime)", v: fmtExact(S.stats.inkEarned || 0, false) },
      { k:"Patrons", v: fmtExact(S.patrons, false) },
      { k:"Prestige preview", v: `Gain +${p.gain} (would have ${p.totalWouldHave})` },
      { k:"Clicks (lifetime)", v: fmtExact(S.stats.clicks || 0, false) },
      { k:"Instruments owned (total)", v: fmtExact(totalOwned, false) },
      { k:"Owned: Woodwinds", v: fmtExact(byFam.Winds || 0, false) },
      { k:"Owned: Brass", v: fmtExact(byFam.Brass || 0, false) },
      { k:"Owned: Percussion", v: fmtExact(byFam.Perc || 0, false) },
      { k:"Owned: Strings", v: fmtExact(byFam.Strings || 0, false) },
      { k:"Owned: Other", v: fmtExact(byFam.Other || 0, false) },
      { k:"Autosave interval", v: "30 seconds" },
    ];

    for (const r of rows){
      const div = document.createElement("div");
      div.className = "mini";
      div.innerHTML = `
        <div class="name">
          <div class="top"><b>${r.k}</b></div>
          <div class="muted smallSans mono">${r.v}</div>
        </div>
        <div class="right">
          <span class="tag">Stats</span>
        </div>
      `;
      el.appendChild(div);
    }
  }

  function renderSettings(){
    $("#settingSuffix").checked = !!S.settings.abbrevLarge;
  }

  function renderAll(){
    renderHUD();
    renderFamilies();
    renderInkUpgrades();
    renderStats();
    renderSettings();
  }

  // ---------- Tick Loop ----------
  let lastHeavy = 0;
  function tick(){
    const t = now();
    let dt = (t - S.lastTick) / 1000;
    S.lastTick = t;
    dt = Math.min(dt, 0.25);

    const gained = totalNps() * dt;
    if (gained > 0){
      S.notes += gained;
      S.lifetimeNotes += gained;
    }

    if (t - S.lastSave > 30000){
      S.lastSave = t;
      localStorage.setItem(KEY, JSON.stringify(S));
    }

    // lightweight always
    renderHUD();

    // heavier: families & lists
    if (t - lastHeavy > 350){
      lastHeavy = t;
      renderFamilies();
      renderInkUpgrades();
      renderStats();
    }
  }

  // ---------- Wire Buttons ----------
  $("#noteBtn").addEventListener("click", ()=>{
    clickNote();
    renderHUD();
  });

  $("#prestigeBtn").addEventListener("click", ()=>{
    doPrestige();
    renderAll();
  });

  $("#saveBtn").addEventListener("click", ()=> save(true));

  $("#resetBtn").addEventListener("click", ()=>{
    const ok = confirm("Hard reset will erase your save completely (including Ink & Patrons). Are you sure?");
    if (!ok) return;
    localStorage.removeItem(KEY);
    localStorage.removeItem("manuscript_note_clicker_v3");
    S = stateDefault();
    toast("Reset complete.");
    renderAll();
  });

  // Bulk buy mode buttons
  document.querySelectorAll("button[data-buymode]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const m = btn.getAttribute("data-buymode");
      setBuyMode(m);
      renderFamilies();
    });
  });

  // Settings toggle
  $("#settingSuffix").addEventListener("change", (e)=>{
    S.settings.abbrevLarge = !!e.target.checked;
    save(false);
    renderAll();
  });

  // ---------- Boot ----------
  applyOffline();
  setBuyMode(S.buyMode);
  setTab(S.ui.tab || "main");
  renderAll();
  setInterval(tick, 100);

  if (S.lifetimeNotes === 0 && S.notes === 0){
    toast("Click ‚ô© to start!");
  }
})();
</script>
</body>
</html>
